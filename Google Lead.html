<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lead Performance Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
/* ============================================================
   RESET & VARIABLES
   ============================================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:    #04040f;
  --surf:  #09091e;
  --card:  rgba(255,255,255,.04);
  --card2: rgba(255,255,255,.07);
  --bdr:   rgba(108,99,255,.18);
  --bdr2:  rgba(108,99,255,.4);
  --acc:   #6c63ff;
  --grn:   #00e5a0;
  --pnk:   #ff6584;
  --org:   #ff9f43;
  --blu:   #54a0ff;
  --txt:   #ddd8f5;
  --muted: #6b6490;
}

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--txt);
  min-height: 100vh;
  overflow-x: hidden;
}

/* grid bg */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(108,99,255,.035) 1px, transparent 1px),
    linear-gradient(90deg, rgba(108,99,255,.035) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

/* ============================================================
   LOADER
   ============================================================ */
#loader {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}
.ring {
  width: 52px; height: 52px;
  border-radius: 50%;
  border: 2px solid rgba(108,99,255,.15);
  border-top-color: var(--acc);
  animation: spin .8s linear infinite;
  box-shadow: 0 0 20px rgba(108,99,255,.25);
}
@keyframes spin { to { transform: rotate(360deg); } }
#lmsg {
  font-family: 'DM Mono', monospace;
  font-size: 11px; letter-spacing: 4px;
  color: var(--muted); text-transform: uppercase;
}
#errmsg {
  display: none;
  max-width: 520px; padding: 28px 32px;
  background: rgba(255,101,132,.06);
  border: 1px solid rgba(255,101,132,.28);
  border-radius: 16px;
  color: #ffb3c1; font-size: 13px;
  line-height: 1.9; text-align: center;
}
#errmsg code {
  display: block; margin-top: 12px;
  background: rgba(0,0,0,.4); padding: 12px 16px;
  border-radius: 8px; font-size: 11px;
  text-align: left; line-height: 1.8;
  color: #a89fff;
}

/* ============================================================
   HEADER
   ============================================================ */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(4,4,15,.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--bdr);
  padding: 0 28px;
  display: flex; align-items: center;
  justify-content: space-between;
  flex-wrap: wrap; gap: 10px;
  min-height: 62px;
}
.logo { display: flex; align-items: center; gap: 12px; }
.logo-icon {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, var(--acc), #9c8fff);
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px;
  box-shadow: 0 0 14px rgba(108,99,255,.4);
}
.logo-text small {
  display: block;
  font-family: 'DM Mono', monospace;
  font-size: 8px; letter-spacing: 3px;
  color: var(--acc); text-transform: uppercase;
}
.logo-text h1 {
  font-family: 'Syne', sans-serif;
  font-size: 16px; font-weight: 700; color: #fff;
}
.hright { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.lpill {
  display: flex; align-items: center; gap: 6px;
  background: rgba(0,229,160,.08);
  border: 1px solid rgba(0,229,160,.2);
  border-radius: 20px; padding: 4px 12px;
  font-size: 11px; color: var(--grn);
  font-family: 'DM Mono', monospace;
}
.ldot {
  width: 6px; height: 6px;
  background: var(--grn); border-radius: 50%;
  animation: lp 1.8s ease-in-out infinite;
  box-shadow: 0 0 5px var(--grn);
}
@keyframes lp { 0%,100%{opacity:1} 50%{opacity:.2} }
#rts  { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
#sname {
  font-family: 'DM Mono', monospace; font-size: 10px; color: var(--acc);
  background: rgba(108,99,255,.08); border: 1px solid var(--bdr);
  border-radius: 20px; padding: 3px 10px;
}
.btnr {
  background: rgba(108,99,255,.12); border: 1px solid var(--bdr);
  color: #a89fff; border-radius: 8px; padding: 6px 13px;
  cursor: pointer; font-size: 12px; font-family: 'DM Sans', sans-serif;
  transition: all .2s;
}
.btnr:hover { background: rgba(108,99,255,.28); color: #fff; }

/* ============================================================
   TABS
   ============================================================ */
.tabs {
  display: flex; gap: 2px;
  background: rgba(255,255,255,.04);
  border-radius: 10px; padding: 3px;
}
.tab {
  padding: 6px 15px; border-radius: 7px;
  border: none; background: transparent; color: var(--muted);
  cursor: pointer; font-size: 12px;
  font-family: 'DM Sans', sans-serif; font-weight: 500;
  transition: all .2s; white-space: nowrap;
}
.tab.on { background: var(--acc); color: #fff; box-shadow: 0 2px 12px rgba(108,99,255,.4); }
.tab:hover:not(.on) { color: var(--txt); background: rgba(255,255,255,.05); }

/* ============================================================
   FILTERS
   ============================================================ */
.filters {
  display: grid; grid-template-columns: repeat(6,1fr);
  gap: 10px; padding: 11px 28px;
  background: rgba(255,255,255,.01);
  border-bottom: 1px solid var(--bdr);
  position: relative; z-index: 1;
}
.fg label {
  display: block;
  font-family: 'DM Mono', monospace;
  font-size: 9px; letter-spacing: 2px;
  color: var(--acc); text-transform: uppercase; margin-bottom: 4px;
}
.fg select {
  width: 100%; background: rgba(255,255,255,.04);
  border: 1px solid var(--bdr); border-radius: 8px;
  color: var(--txt); padding: 7px 10px;
  font-size: 12px; font-family: 'DM Sans', sans-serif;
  outline: none; cursor: pointer;
  transition: border-color .2s;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b6490'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.fg select:focus { border-color: var(--acc); }
.fg select:disabled { opacity: .3; cursor: not-allowed; }
option { background: #0a0a1f; }
.btnrst {
  margin-top: 13px; width: 100%; padding: 7px;
  background: transparent; border: 1px solid rgba(255,255,255,.08);
  border-radius: 8px; color: var(--muted); cursor: pointer;
  font-size: 11px; font-family: 'DM Mono', monospace; letter-spacing: 1px;
  transition: all .2s;
}
.btnrst:hover { border-color: var(--acc); color: var(--acc); }

/* ============================================================
   KPIs
   ============================================================ */
.kpis {
  display: grid; grid-template-columns: repeat(4,1fr);
  gap: 13px; padding: 18px 28px;
  position: relative; z-index: 1;
}
.kpi {
  background: var(--card); border: 1px solid var(--bdr);
  border-radius: 14px; padding: 18px 20px;
  position: relative; overflow: hidden;
  transition: all .3s;
}
.kpi:hover { background: var(--card2); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,.3); }
.kacc { position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.kgl  { position: absolute; top:-30px; left:-30px; width:90px; height:90px; border-radius:50%; opacity:.07; filter:blur(18px); }
.k1 .kacc{background:linear-gradient(90deg,var(--acc),transparent)} .k1 .kgl{background:var(--acc)}
.k2 .kacc{background:linear-gradient(90deg,var(--grn),transparent)} .k2 .kgl{background:var(--grn)}
.k3 .kacc{background:linear-gradient(90deg,var(--pnk),transparent)} .k3 .kgl{background:var(--pnk)}
.k4 .kacc{background:linear-gradient(90deg,var(--org),transparent)} .k4 .kgl{background:var(--org)}
.klbl {
  font-family: 'DM Mono', monospace;
  font-size: 9px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 7px;
}
.k1 .klbl{color:var(--acc)} .k2 .klbl{color:var(--grn)}
.k3 .klbl{color:var(--pnk)} .k4 .klbl{color:var(--org)}
.kval {
  font-family: 'Syne', sans-serif;
  font-size: 38px; font-weight: 800; color: #fff;
  line-height: 1; letter-spacing: -1px;
}
.ksub { font-size: 11px; color: var(--muted); margin-top: 5px; }

/* ============================================================
   CONTENT AREA
   ============================================================ */
.content { padding: 0 28px 36px; position: relative; z-index: 1; }
.hidden  { display: none !important; }
.g2   { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.full { grid-column: 1 / -1; }
.card {
  background: var(--card); border: 1px solid var(--bdr);
  border-radius: 14px; padding: 22px; transition: border-color .2s;
}
.card:hover { border-color: rgba(108,99,255,.32); }
.cttl {
  font-family: 'DM Mono', monospace;
  font-size: 9px; letter-spacing: 3px;
  color: var(--acc); text-transform: uppercase;
  margin-bottom: 18px;
  display: flex; align-items: center; gap: 8px;
}
.cttl::before {
  content: ''; display: inline-block;
  width: 3px; height: 11px; background: var(--acc); border-radius: 2px;
}
.nodata { color: var(--muted); text-align: center; padding: 44px; font-size: 12px; font-family: 'DM Mono', monospace; }
.bdg   { display: inline-block; border-radius: 20px; padding: 2px 9px; font-size: 11px; font-weight: 600; font-family: 'DM Mono', monospace; }

/* manager bars */
.brow { margin-bottom: 16px; }
.browtop { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.browname { display: flex; align-items: center; gap: 9px; font-size: 13px; font-weight: 500; }
.dot10 { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.trk  { background: rgba(255,255,255,.05); border-radius: 6px; height: 6px; overflow: hidden; }
.trkf { border-radius: 6px; height: 100%; transition: width .6s cubic-bezier(.16,1,.3,1); }
.trk3 { background: rgba(255,255,255,.03); border-radius: 3px; height: 3px; margin-top: 3px; overflow: hidden; }
.trkgn{ border-radius: 3px; height: 100%; background: var(--grn); opacity: .6; }

/* trend */
.trow  { margin-bottom: 13px; }
.trowtop { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
.tbar  { position: relative; background: rgba(255,255,255,.04); border-radius: 6px; height: 10px; overflow: hidden; }
.tbm, .tba { position: absolute; border-radius: 6px; }
.tbm { height: 100%; }
.tba { height: 4px; bottom: 3px; background: var(--grn); opacity: .8; }

/* top counsellors */
.top5 { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; }
.tcard { border-radius: 12px; padding: 15px; transition: transform .2s; }
.tcard:hover { transform: translateY(-3px); }
.trank  { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-bottom: 3px; }
.tname  { font-size: 13px; color: #fff; font-weight: 600; margin-bottom: 2px; line-height: 1.3; }
.tmgr   { font-size: 11px; color: var(--muted); margin-bottom: 9px; }
.tleads { font-family: 'Syne', sans-serif; font-size: 27px; font-weight: 800; line-height: 1; }
.tcv    { font-size: 11px; color: var(--grn); margin-top: 3px; font-family: 'DM Mono', monospace; }

/* tables */
.twrap { border-radius: 14px; border: 1px solid var(--bdr); overflow-x: auto; }
table  { width: 100%; border-collapse: collapse; }
thead tr { background: rgba(108,99,255,.09); }
th {
  padding: 12px 16px; text-align: left;
  font-family: 'DM Mono', monospace; font-size: 9px;
  letter-spacing: 2px; color: var(--acc);
  text-transform: uppercase; white-space: nowrap;
}
td { padding: 11px 16px; border-top: 1px solid rgba(255,255,255,.04); font-size: 13px; color: var(--txt); }
tr:hover td { background: rgba(255,255,255,.02); }
.big { font-family: 'Syne', sans-serif; font-size: 21px; font-weight: 700; }
.cvw { display: flex; align-items: center; gap: 9px; }
.cvt { width: 55px; background: rgba(255,255,255,.06); border-radius: 4px; height: 5px; }
.cvf { border-radius: 4px; height: 100%; }

/* process */
.pgrid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; }
.pc { background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid var(--bdr); transition: all .2s; }
.pc:hover { transform: translateY(-2px); }
.pchdr  { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
.pctitle{ font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; color: #fff; }
.pcnums { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; margin-bottom: 14px; }
.pclbl  { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); margin-bottom: 3px; letter-spacing: 1px; }
.pcval  { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; }

/* calendar */
.calwrap { display: grid; grid-template-columns: 1fr 270px; gap: 14px; }
.calnav  { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.calbtn  {
  background: rgba(108,99,255,.1); border: 1px solid var(--bdr);
  border-radius: 8px; color: #a89fff; cursor: pointer;
  padding: 8px 14px; font-size: 18px; line-height: 1; transition: all .2s;
}
.calbtn:hover { background: rgba(108,99,255,.25); color: #fff; }
.calmn { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 700; color: #fff; text-align: center; }
.calyr { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); text-align: center; margin-top: 2px; }
.cgrid { display: grid; grid-template-columns: repeat(7,1fr); gap: 3px; }
.cdhdr { text-align: center; font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); padding: 4px 0; letter-spacing: 1px; }
.cday  {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  border-radius: 9px; cursor: pointer; font-size: 13px;
  border: 1px solid transparent; transition: all .15s; position: relative;
}
.cday:hover { background: rgba(255,255,255,.06); }
.cday.has { background: rgba(108,99,255,.1); color: #a89fff; border-color: rgba(108,99,255,.3); }
.cday.sel { background: linear-gradient(135deg,var(--acc),#9c8fff); color: #fff; font-weight: 700; box-shadow: 0 2px 12px rgba(108,99,255,.4); }
.cdot  { position: absolute; bottom: 3px; width: 4px; height: 4px; border-radius: 50%; background: var(--acc); }
.calleg{ display: flex; gap: 18px; margin-top: 14px; justify-content: center; }
.leg   { display: flex; align-items: center; gap: 6px; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
.legb  { width: 11px; height: 11px; border-radius: 3px; }
.calside{ display: flex; flex-direction: column; gap: 13px; }
.wki  { padding: 10px 13px; margin-bottom: 6px; background: rgba(108,99,255,.06); border-radius: 9px; border-left: 3px solid var(--acc); }
.wkn  { font-family: 'Syne', sans-serif; font-size: 12px; color: #a89fff; font-weight: 700; }
.wkd  { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 2px; }
.selscroll { max-height: 155px; overflow-y: auto; }
.seli  { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,.04); font-size: 12px; }
.selrm { background: none; border: none; color: var(--pnk); cursor: pointer; font-size: 16px; line-height: 1; }
.btnclr{
  margin-top: 9px; width: 100%; padding: 7px;
  background: rgba(255,101,132,.08); border: 1px solid rgba(255,101,132,.25);
  border-radius: 8px; color: var(--pnk); cursor: pointer;
  font-size: 11px; font-family: 'DM Mono', monospace;
}

/* responsive */
@media(max-width:1024px){
  .filters, .kpis { grid-template-columns: 1fr 1fr; }
  .g2, .top5, .pgrid, .calwrap { grid-template-columns: 1fr; }
  .full { grid-column: 1; }
  header, .kpis, .content, .filters { padding-left: 14px; padding-right: 14px; }
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ring"></div>
  <div id="lmsg">CONNECTING TO GOOGLE SHEET...</div>
  <div id="errmsg"></div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üìä</div>
    <div class="logo-text">
      <small>Live Analytics</small>
      <h1>Lead Performance</h1>
    </div>
  </div>
  <div class="hright">
    <div class="lpill"><span class="ldot"></span>LIVE</div>
    <span id="sname"></span>
    <span id="rts"></span>
    <button class="btnr" onclick="loadData()">‚Üª Refresh</button>
  </div>
  <div class="tabs">
    <button class="tab on"  onclick="go('overview')">Overview</button>
    <button class="tab"     onclick="go('managers')">Managers</button>
    <button class="tab"     onclick="go('counsellors')">Counsellors</button>
    <button class="tab"     onclick="go('process')">Process</button>
    <button class="tab"     onclick="go('calendar')">Calendar</button>
  </div>
</header>

<!-- FILTERS -->
<div class="filters">
  <div class="fg"><label>Month</label>
    <select id="fm" onchange="onMonth()"><option value="">All Months</option></select></div>
  <div class="fg"><label>Week</label>
    <select id="fw" onchange="render()" disabled><option value="">All Weeks</option></select></div>
  <div class="fg"><label>Manager</label>
    <select id="fmg" onchange="onMgr()"><option value="">All Managers</option></select></div>
  <div class="fg"><label>Process</label>
    <select id="fp" onchange="render()"><option value="">All Processes</option></select></div>
  <div class="fg"><label>Counsellor</label>
    <select id="fc" onchange="render()"><option value="">All Counsellors</option></select></div>
  <div class="fg" style="display:flex;align-items:flex-end">
    <button class="btnrst" onclick="resetF()">‚úï RESET</button>
  </div>
</div>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi k1"><div class="kacc"></div><div class="kgl"></div>
    <div class="klbl">Leads Received</div><div class="kval" id="kv1">‚Äî</div><div class="ksub" id="ks1">records</div></div>
  <div class="kpi k2"><div class="kacc"></div><div class="kgl"></div>
    <div class="klbl">Apps Achieved</div><div class="kval" id="kv2">‚Äî</div><div class="ksub">converted</div></div>
  <div class="kpi k3"><div class="kacc"></div><div class="kgl"></div>
    <div class="klbl">Conversion Rate</div><div class="kval" id="kv3">‚Äî</div><div class="ksub">rcv ‚Üí ach</div></div>
  <div class="kpi k4"><div class="kacc"></div><div class="kgl"></div>
    <div class="klbl">Active Managers</div><div class="kval" id="kv4">‚Äî</div><div class="ksub" id="ks4">teams</div></div>
</div>

<!-- CONTENT -->
<div class="content">

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="g2">
      <div class="card"><div class="cttl">Manager Performance</div><div id="mgrbars"></div></div>
      <div class="card"><div class="cttl">Weekly Trend</div><div id="trend"></div></div>
      <div class="card full"><div class="cttl">Top Performing Counsellors</div><div class="top5" id="topcards"></div></div>
    </div>
  </div>

  <!-- MANAGERS -->
  <div id="tab-managers" class="hidden">
    <div class="twrap"><table>
      <thead><tr><th>Manager</th><th>Received</th><th>Achieved</th><th>Conv %</th><th>Progress</th><th>Processes</th></tr></thead>
      <tbody id="mgrtbody"></tbody>
    </table></div>
  </div>

  <!-- COUNSELLORS -->
  <div id="tab-counsellors" class="hidden">
    <div class="twrap"><table>
      <thead><tr><th>#</th><th>Counsellor</th><th>Manager</th><th>Team Leader</th><th>Received</th><th>Achieved</th><th>Conv %</th></tr></thead>
      <tbody id="cnsltbody"></tbody>
    </table></div>
  </div>

  <!-- PROCESS -->
  <div id="tab-process" class="hidden">
    <div class="pgrid" id="procgrid"></div>
  </div>

  <!-- CALENDAR -->
  <div id="tab-calendar" class="hidden">
    <div class="calwrap">
      <div class="card">
        <div class="calnav">
          <button class="calbtn" onclick="calNav(-1)">‚Äπ</button>
          <div><div class="calmn" id="calmn"></div><div class="calyr" id="calyr"></div></div>
          <button class="calbtn" onclick="calNav(1)">‚Ä∫</button>
        </div>
        <div class="cgrid" id="cgrid"></div>
        <div class="calleg">
          <div class="leg"><div class="legb" style="background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.3)"></div>Has data</div>
          <div class="leg"><div class="legb" style="background:linear-gradient(135deg,#6c63ff,#9c8fff)"></div>Selected</div>
        </div>
      </div>
      <div class="calside">
        <div class="card"><div class="cttl">Week Ranges</div><div id="wkranges"></div></div>
        <div class="card" style="flex:1">
          <div class="cttl">Selected ¬∑ <span id="selcnt">0</span></div>
          <div class="selscroll" id="sellist"></div>
          <button class="btnclr" id="btnclr" onclick="clearSel()" style="display:none">CLEAR ALL</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /content -->

<script>
// ================================================================
//  ‚öôÔ∏è  YOUR APPS SCRIPT URL ‚Äî update if you redeploy
// ================================================================
var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPf5ldQHkRk83JDPLpRJSDVemIHqhegAtO0aABUZtgIHaQ-kuVbEwvkYfpqQjmogwV/exec";
// ================================================================

var ALL = [], FOPTS = {}, CT = "overview", SEL = new Set(), CM = 0, CY = 2025;
var MN  = ["January","February","March","April","May","June","July","August","September","October","November","December"];
var DN  = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var MD  = [31,28,28,31,30,31,30,31,31,30,31,30,31];
var MM  = {
  January : {r:[[1,11],[12,18],[19,25],[26,31]]},
  February: {r:[[1,7],[8,14],[15,21],[22,28]]},
  March   : {r:[[1,7],[8,14],[15,21],[22,31]]},
  April   : {r:[[1,7],[8,14],[15,21],[22,30]]},
  May     : {r:[[1,7],[8,14],[15,21],[22,31]]},
  June    : {r:[[1,7],[8,14],[15,21],[22,30]]}
};
var MC  = {"Aasif":"#6c63ff","Aslam":"#00e5a0","Deepesh":"#ff6584","Manas Ranjan Nayak":"#ff9f43"};
var PAL = ["#6c63ff","#00e5a0","#ff6584","#ff9f43","#54a0ff","#9c8fff","#ffd32a","#0be881","#ff5e57","#48dbfb"];

// ‚îÄ‚îÄ JSONP helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Creates a <script> tag that calls SCRIPT_URL?action=X&callback=fn
// This completely bypasses CORS ‚Äî works from any domain including GitHub Pages
function jsonp(action, callback) {
  var fnName = "_jsonp_" + action + "_" + Date.now();
  window[fnName] = function(data) {
    delete window[fnName];
    var el = document.getElementById(fnName);
    if (el) el.parentNode.removeChild(el);
    callback(null, data);
  };
  var s = document.createElement("script");
  s.id  = fnName;
  s.src = SCRIPT_URL + "?action=" + action + "&callback=" + fnName + "&t=" + Date.now();
  s.onerror = function() {
    delete window[fnName];
    var el = document.getElementById(fnName);
    if (el) el.parentNode.removeChild(el);
    callback(new Error("Failed to load script for action: " + action));
  };
  document.head.appendChild(s);
}

// ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener("DOMContentLoaded", loadData);

function loadData() {
  sm("CONNECTING TO GOOGLE SHEET...");
  document.getElementById("loader").style.display = "flex";

  jsonp("getFilterOptions", function(err, o) {
    if (err) { showErr(err.message); return; }
    if (!o || !o.ok) { showErr((o && o.error) || "getFilterOptions failed"); return; }

    FOPTS = o;
    fillF(o);
    sm("LOADING SHEET DATA...");

    jsonp("getLiveData", function(err2, d) {
      if (err2) { showErr(err2.message); return; }
      if (!d || !d.ok) { showErr((d && d.error) || "getLiveData failed"); return; }

      ALL = d.rows || [];
      document.getElementById("rts").textContent = "Updated " + new Date().toLocaleTimeString();
      if (d.sheetInfo) {
        document.getElementById("sname").textContent = d.sheetInfo.name + " ¬∑ " + d.sheetInfo.totalRows + " rows";
      }
      hideLoader();
      go("overview");
    });
  });
}

function sm(t) { var e = document.getElementById("lmsg"); if (e) e.textContent = t; }
function hideLoader() { document.getElementById("loader").style.display = "none"; }
function showErr(msg) {
  document.getElementById("lmsg").style.display = "none";
  var el = document.getElementById("errmsg");
  el.innerHTML =
    "<b>‚ö† Could not load data</b><br><br>" + msg +
    "<br><br><b>Make sure your Code.gs is deployed with the latest version</b><br>" +
    "that supports <code>?action=&callback=</code> (JSONP).<br><br>" +
    "Steps: Deploy ‚Üí Manage Deployments ‚Üí Edit ‚úèÔ∏è ‚Üí New Version ‚Üí Deploy";
  el.style.display = "block";
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fillF(o) {
  function add(id, a) {
    var s = document.getElementById(id);
    (a || []).forEach(function(v) {
      var op = document.createElement("option");
      op.value = v; op.textContent = v; s.appendChild(op);
    });
  }
  add("fm", o.months); add("fmg", o.managers);
  add("fp", o.processes); add("fc", o.counsellors);
}
function onMonth() {
  var m = gv("fm"), ws = document.getElementById("fw");
  ws.innerHTML = '<option value="">All Weeks</option>';
  ws.disabled = !m;
  if (m && FOPTS.weeksByMonth && FOPTS.weeksByMonth[m]) {
    FOPTS.weeksByMonth[m].forEach(function(w) {
      var o = document.createElement("option"); o.value = w; o.textContent = w; ws.appendChild(o);
    });
  }
  render();
}
function onMgr() {
  var mg = gv("fmg"), cs = document.getElementById("fc");
  cs.innerHTML = '<option value="">All Counsellors</option>';
  var l = mg
    ? [...new Set(ALL.filter(function(d){ return d.manager === mg; }).map(function(d){ return d.counsellor; }))]
    : (FOPTS.counsellors || []);
  l.sort().forEach(function(c) {
    var o = document.createElement("option"); o.value = c; o.textContent = c; cs.appendChild(o);
  });
  render();
}
function resetF() {
  ["fm","fw","fmg","fp","fc"].forEach(function(id){ document.getElementById(id).value = ""; });
  document.getElementById("fw").disabled = true;
  render();
}

// ‚îÄ‚îÄ DATA HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fd() {
  var m=gv("fm"),w=gv("fw"),mg=gv("fmg"),p=gv("fp"),c=gv("fc");
  return ALL.filter(function(d){
    return (!m||d.month===m)&&(!w||d.week===w)&&(!mg||d.manager===mg)&&(!p||d.process===p)&&(!c||d.counsellor===c);
  });
}
function ag(data, key) {
  var map = {};
  data.forEach(function(d) {
    var k = d[key]; if (!k) return;
    if (!map[k]) map[k] = { name:k,r:0,a:0,mgr:d.manager,tl:d.teamLeader,procs:{},mgrs:{} };
    map[k].r += d.leadsReceived; map[k].a += d.leadsAchieved;
    map[k].procs[d.process] = 1; map[k].mgrs[d.manager] = 1;
  });
  return Object.values(map).map(function(x){
    return Object.assign({}, x, {
      procs: Object.keys(x.procs), mgrs: Object.keys(x.mgrs),
      ratio: x.r > 0 ? ((x.a / x.r) * 100).toFixed(1) : "0.0"
    });
  }).sort(function(a,b){ return b.r - a.r; });
}
function gv(id) { return document.getElementById(id).value; }

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  var data = fd();
  var tR = data.reduce(function(s,d){ return s+d.leadsReceived; }, 0);
  var tA = data.reduce(function(s,d){ return s+d.leadsAchieved; }, 0);
  var cv = tR > 0 ? ((tA/tR)*100).toFixed(1) : "0.0";
  var mgrs = ag(data, "manager");
  sv("kv1", tR); sv("ks1", data.length + " records");
  sv("kv2", tA); sv("kv3", cv + "%");
  sv("kv4", mgrs.filter(function(m){ return m.r > 0; }).length);
  sv("ks4", "of " + mgrs.length + " teams");
  if (CT === "overview")    rOv(data, mgrs, tR);
  if (CT === "managers")    rMg(data, mgrs);
  if (CT === "counsellors") rCn(data);
  if (CT === "process")     rPr(data);
  if (CT === "calendar")    rCal();
}

// OVERVIEW
function rOv(data, mgrs, tR) {
  var h = "";
  mgrs.forEach(function(m) {
    var c = MC[m.name] || "#888", pct = tR > 0 ? (m.r/tR)*100 : 0;
    h += '<div class="brow"><div class="browtop">';
    h += '<span class="browname"><span class="dot10" style="background:'+c+';box-shadow:0 0 5px '+c+'"></span>'+xe(m.name)+'</span>';
    h += '<span><span class="bdg" style="background:'+c+'18;color:'+c+';border:1px solid '+c+'30">'+m.r+'</span> ';
    h += '<span class="bdg" style="background:rgba(0,229,160,.1);color:#00e5a0;border:1px solid rgba(0,229,160,.22)">'+m.ratio+'%</span></span></div>';
    h += '<div class="trk"><div class="trkf" style="width:'+pct+'%;background:linear-gradient(90deg,'+c+','+c+'55)"></div></div>';
    h += '<div class="trk3"><div class="trkgn" style="width:'+m.ratio+'%"></div></div></div>';
  });
  sv("mgrbars", h || nd());

  var tm = {};
  data.forEach(function(d) {
    var k = d.month + "|" + d.week;
    var wm = d.week.match(/Week \d+/);
    var lbl = d.month.slice(0,3) + " " + (wm ? wm[0] : d.week);
    if (!tm[k]) tm[k] = {l:lbl, r:0, a:0};
    tm[k].r += d.leadsReceived; tm[k].a += d.leadsAchieved;
  });
  var tr = Object.values(tm).filter(function(t){ return t.r > 0; });
  var mx = Math.max.apply(null, tr.map(function(t){ return t.r; }).concat([1]));
  var th = "";
  tr.forEach(function(t, i) {
    var c = PAL[i % PAL.length];
    th += '<div class="trow"><div class="trowtop">';
    th += '<span style="color:var(--muted);font-family:DM Mono,monospace;font-size:11px">'+t.l+'</span>';
    th += '<span style="font-size:12px">'+t.r+' <span style="color:var(--muted)">rcv</span> ¬∑ <span style="color:var(--grn)">'+t.a+'</span> ach</span></div>';
    th += '<div class="tbar"><div class="tbm" style="width:'+(t.r/mx*100)+'%;background:linear-gradient(90deg,'+c+','+c+'44)"></div>';
    th += '<div class="tba" style="width:'+(t.a/mx*100)+'%"></div></div></div>';
  });
  sv("trend", th || nd());

  var top = ag(data, "counsellor").filter(function(c){ return c.r > 0; }).slice(0, 5);
  var ch = "";
  top.forEach(function(c, i) {
    var col = MC[c.mgr] || "#888";
    ch += '<div class="tcard" style="background:'+col+'0e;border:1px solid '+col+'25">';
    ch += '<div class="trank">#'+(i+1)+'</div>';
    ch += '<div class="tname">'+xe(c.name)+'</div>';
    ch += '<div class="tmgr">'+xe(c.mgr)+'</div>';
    ch += '<div class="tleads" style="color:'+col+'">'+c.r+'</div>';
    ch += '<div class="tcv">'+c.ratio+'% conv</div></div>';
  });
  sv("topcards", ch || nd());
}

// MANAGERS TABLE
function rMg(data, mgrs) {
  var h = "";
  mgrs.forEach(function(m) {
    var c = MC[m.name] || "#888", rc = +m.ratio >= 40 ? "#00e5a0" : "#ff6584";
    var ps = m.procs.slice(0,4).map(function(p){
      return '<span class="bdg" style="background:rgba(255,255,255,.04);color:var(--muted);border:1px solid rgba(255,255,255,.07)">'+xe(p)+'</span>';
    }).join(" ");
    if (m.procs.length > 4) ps += ' <span class="bdg" style="background:rgba(255,255,255,.04);color:var(--muted)">+'+(m.procs.length-4)+'</span>';
    h += '<tr>';
    h += '<td><span style="display:inline-flex;align-items:center;gap:9px"><span style="width:10px;height:10px;border-radius:50%;background:'+c+';box-shadow:0 0 5px '+c+';display:inline-block"></span>'+xe(m.name)+'</span></td>';
    h += '<td class="big" style="color:'+c+'">'+m.r+'</td>';
    h += '<td class="big" style="color:#00e5a0">'+m.a+'</td>';
    h += '<td><span class="bdg" style="background:'+rc+'15;color:'+rc+';border:1px solid '+rc+'30">'+m.ratio+'%</span></td>';
    h += '<td><div class="cvw"><div class="cvt"><div class="cvf" style="width:'+m.ratio+'%;background:linear-gradient(90deg,'+c+',#00e5a0)"></div></div></div></td>';
    h += '<td>'+ps+'</td></tr>';
  });
  sv("mgrtbody", h);
}

// COUNSELLORS TABLE
function rCn(data) {
  var stats = ag(data, "counsellor"), h = "";
  stats.forEach(function(c, i) {
    var col = MC[c.mgr] || "#888", rc = +c.ratio >= 40 ? "#00e5a0" : "#ff6584";
    h += '<tr>';
    h += '<td style="color:var(--muted);font-family:DM Mono,monospace;font-size:11px">'+(i+1)+'</td>';
    h += '<td style="font-weight:600;color:#fff">'+xe(c.name)+'</td>';
    h += '<td><span class="bdg" style="background:'+col+'15;color:'+col+';border:1px solid '+col+'30">'+xe(c.mgr)+'</span></td>';
    h += '<td style="color:var(--muted);font-size:12px">'+xe(c.tl||"")+'</td>';
    h += '<td class="big" style="color:'+col+'">'+c.r+'</td>';
    h += '<td class="big" style="color:#00e5a0">'+c.a+'</td>';
    h += '<td><div class="cvw"><div class="cvt"><div class="cvf" style="width:'+c.ratio+'%;background:'+rc+'"></div></div>';
    h += '<span style="font-family:DM Mono,monospace;font-size:11px;color:'+rc+';min-width:38px">'+c.ratio+'%</span></div></td></tr>';
  });
  sv("cnsltbody", h);
}

// PROCESS CARDS
function rPr(data) {
  var stats = ag(data, "process");
  var mx = Math.max.apply(null, stats.map(function(s){ return s.r; }).concat([1]));
  var h = "";
  stats.forEach(function(p, i) {
    var c = PAL[i % PAL.length], rc = +p.ratio >= 40 ? "#00e5a0" : "#ff6584";
    h += '<div class="pc" style="border-color:'+c+'25">';
    h += '<div class="pchdr"><div class="pctitle">'+xe(p.name)+'</div>';
    h += '<span class="bdg" style="background:'+rc+'12;color:'+rc+';border:1px solid '+rc+'30">'+p.ratio+'%</span></div>';
    h += '<div class="pcnums">';
    h += '<div><div class="pclbl">RECEIVED</div><div class="pcval" style="color:'+c+'">'+p.r+'</div></div>';
    h += '<div><div class="pclbl">ACHIEVED</div><div class="pcval" style="color:#00e5a0">'+p.a+'</div></div>';
    h += '<div><div class="pclbl">COUNSELLORS</div><div style="font-family:Syne,sans-serif;font-size:20px;font-weight:700">'+p.procs.length+'</div></div>';
    h += '<div><div class="pclbl">MANAGERS</div><div style="font-family:Syne,sans-serif;font-size:20px;font-weight:700">'+p.mgrs.length+'</div></div>';
    h += '</div>';
    h += '<div style="background:rgba(255,255,255,.04);border-radius:5px;height:5px">';
    h += '<div style="width:'+(p.r/mx*100)+'%;background:linear-gradient(90deg,'+c+','+c+'44);border-radius:5px;height:100%"></div></div></div>';
  });
  sv("procgrid", h || nd());
}

// CALENDAR
function rCal() {
  var mn = MN[CM]; sv("calmn", mn); sv("calyr", CY);
  var meta = MM[mn], act = new Set();
  if (meta) meta.r.forEach(function(r){ for (var d = r[0]; d <= r[1]; d++) act.add(d); });
  var fday = new Date(CY, CM, 1).getDay(), dim = MD[CM];
  var h = DN.map(function(d){ return '<div class="cdhdr">'+d+'</div>'; }).join("");
  for (var i = 0; i < fday; i++) h += "<div></div>";
  for (var day = 1; day <= dim; day++) {
    var key = CY+"-"+CM+"-"+day;
    var isSel = SEL.has(key), isAct = act.has(day);
    var cls = "cday" + (isSel ? " sel" : isAct ? " has" : "");
    h += '<div class="'+cls+'" onclick="tD('+day+')" title="'+(wkD(mn,day)||"")+'">'+day+(isAct&&!isSel?'<span class="cdot"></span>':"")+"</div>";
  }
  sv("cgrid", h);
  var wh = "";
  if (meta) meta.r.forEach(function(r, i){ wh += '<div class="wki"><div class="wkn">Week '+(i+1)+'</div><div class="wkd">'+r[0]+' ‚Äì '+r[1]+' '+mn+'</div></div>'; });
  else wh = '<div style="color:var(--muted);font-size:11px;font-family:DM Mono,monospace">No week data</div>';
  sv("wkranges", wh);
  var sel = [...SEL].sort();
  sv("selcnt", sel.length);
  document.getElementById("btnclr").style.display = sel.length ? "" : "none";
  var sh = sel.map(function(k){
    var p = k.split("-");
    return '<div class="seli"><span>'+(MN[+p[1]]||p[1])+' '+p[2]+', '+p[0]+'</span><button class="selrm" onclick="rD(\''+k+'\')">&times;</button></div>';
  }).join("");
  sv("sellist", sh || '<div style="color:var(--muted);font-size:11px;font-family:DM Mono,monospace;text-align:center;padding:18px 0">Click days to select</div>');
}

function wkD(mn, d){ var m = MM[mn]; if (!m) return null; var i = m.r.findIndex(function(r){ return d>=r[0]&&d<=r[1]; }); return i >= 0 ? "Week "+(i+1) : null; }
function tD(d){ var k=CY+"-"+CM+"-"+d; SEL.has(k)?SEL.delete(k):SEL.add(k); rCal(); }
function rD(k){ SEL.delete(k); rCal(); }
function clearSel(){ SEL.clear(); rCal(); }
function calNav(dir){ CM+=dir; if(CM<0){CM=11;CY--;} else if(CM>11){CM=0;CY++;} rCal(); }

function go(t) {
  document.querySelectorAll("[id^='tab-']").forEach(function(el){ el.classList.add("hidden"); });
  document.getElementById("tab-"+t).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(function(b){
    b.classList.toggle("on", b.getAttribute("onclick").indexOf("'"+t+"'") >= 0);
  });
  CT = t; render();
}
function sv(id, v){ var el = document.getElementById(id); if (el) el.innerHTML = v; }
function nd(){ return '<div class="nodata">‚Äî no data for current filters ‚Äî</div>'; }
function xe(s){ var d = document.createElement("div"); d.textContent = s||""; return d.innerHTML; }
</script>
</body>
</html>
