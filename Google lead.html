<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Google Lead Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#09091c;--card:rgba(255,255,255,.045);--bdr:rgba(124,92,252,.2);
  --acc:#7c5cfc;--grn:#34d399;--pnk:#f472b6;--org:#fb923c;--blu:#60a5fa;
  --txt:#e2d9ff;--muted:#7a6fa0;--dk:#100f27;
}
body{font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;
  flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.spin{width:48px;height:48px;border:3px solid rgba(124,92,252,.2);
  border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
#loader-msg{color:var(--muted);font-size:13px;letter-spacing:3px;}
#err-box{display:none;color:var(--pnk);font-size:13px;text-align:center;max-width:400px;
  padding:18px 22px;background:rgba(244,114,182,.08);border:1px solid rgba(244,114,182,.25);
  border-radius:10px;}

/* HEADER */
header{position:sticky;top:0;z-index:100;background:rgba(9,9,28,.92);
  backdrop-filter:blur(12px);border-bottom:1px solid var(--bdr);
  padding:13px 24px;display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px;}
.hd-left small{display:block;font-size:9px;letter-spacing:4px;color:var(--acc);
  text-transform:uppercase;margin-bottom:3px;}
.hd-left h1{font-size:20px;font-weight:700;color:#fff;}
.live-pill{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--grn);
  background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);
  border-radius:20px;padding:4px 12px;}
.ldot{width:7px;height:7px;background:var(--grn);border-radius:50%;
  animation:pulse 1.6s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.75)}}
#refresh-ts{font-size:11px;color:var(--muted);}
.btn-ref{background:rgba(124,92,252,.15);border:1px solid var(--bdr);color:#c4b5fd;
  border-radius:8px;padding:7px 14px;cursor:pointer;font-size:12px;font-family:inherit;
  transition:all .2s;}
.btn-ref:hover{background:rgba(124,92,252,.3);}

/* TABS */
.tabs{display:flex;gap:5px;flex-wrap:wrap;}
.tab{padding:7px 17px;border-radius:20px;border:1px solid var(--bdr);background:transparent;
  color:var(--muted);cursor:pointer;font-size:12px;font-family:inherit;
  text-transform:capitalize;letter-spacing:.4px;transition:all .2s;}
.tab.on{border-color:var(--acc);background:rgba(124,92,252,.18);color:#c4b5fd;}

/* FILTERS */
.filters{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:13px 24px;
  background:rgba(255,255,255,.015);border-bottom:1px solid var(--bdr);}
.fg label{display:block;font-size:9px;letter-spacing:2.5px;color:var(--acc);
  text-transform:uppercase;margin-bottom:4px;}
.fg select{width:100%;background:var(--dk);border:1px solid var(--bdr);border-radius:8px;
  color:var(--txt);padding:8px 11px;font-size:13px;font-family:inherit;outline:none;cursor:pointer;
  transition:border .2s;}
.fg select:focus{border-color:var(--acc);}
.fg select:disabled{opacity:.35;cursor:default;}
.btn-rst{margin-top:18px;width:100%;padding:8px;background:rgba(122,111,160,.1);
  border:1px solid rgba(122,111,160,.25);border-radius:8px;color:var(--muted);cursor:pointer;
  font-size:12px;font-family:inherit;transition:all .2s;}
.btn-rst:hover{color:var(--txt);border-color:var(--acc);}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:16px 24px;}
.kpi{border-radius:14px;padding:18px 20px;position:relative;overflow:hidden;
  background:var(--card);}
.kpi::before{content:'';position:absolute;inset:0 0 auto 0;height:2px;}
.kpi.k1{border:1px solid rgba(124,92,252,.25);} .kpi.k1::before{background:linear-gradient(90deg,var(--acc),transparent);}
.kpi.k2{border:1px solid rgba(52,211,153,.25);}  .kpi.k2::before{background:linear-gradient(90deg,var(--grn),transparent);}
.kpi.k3{border:1px solid rgba(244,114,182,.25);} .kpi.k3::before{background:linear-gradient(90deg,var(--pnk),transparent);}
.kpi.k4{border:1px solid rgba(251,146,60,.25);}  .kpi.k4::before{background:linear-gradient(90deg,var(--org),transparent);}
.kpi-lbl{font-size:9px;letter-spacing:3px;text-transform:uppercase;margin-bottom:6px;}
.kpi.k1 .kpi-lbl{color:var(--acc);} .kpi.k2 .kpi-lbl{color:var(--grn);}
.kpi.k3 .kpi-lbl{color:var(--pnk);} .kpi.k4 .kpi-lbl{color:var(--org);}
.kpi-val{font-size:36px;font-weight:800;color:#fff;line-height:1;}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:5px;}

/* CONTENT */
.content{padding:0 24px 32px;}
.hidden{display:none!important;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.full{grid-column:1/-1;}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:22px;}
.card-ttl{font-size:9px;letter-spacing:3px;color:var(--acc);text-transform:uppercase;margin-bottom:18px;}
.no-data{color:var(--muted);text-align:center;padding:40px;font-size:14px;}

/* BADGES */
.bdg{display:inline-block;border-radius:20px;padding:2px 9px;font-size:11px;font-weight:600;}

/* BAR ROWS */
.brow{margin-bottom:16px;}
.brow-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.brow-name{display:flex;align-items:center;gap:8px;font-size:13px;}
.dot8{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.brow-bdgs{display:flex;gap:6px;}
.trk{background:rgba(255,255,255,.06);border-radius:4px;}
.trk-fill{border-radius:4px;height:100%;transition:width .5s;}
.trk7{height:7px;}
.trk3{height:3px;margin-top:3px;background:rgba(255,255,255,.03);border-radius:3px;}
.trk3-fill{border-radius:3px;height:100%;background:var(--grn);opacity:.7;}

/* TREND */
.trow{margin-bottom:12px;}
.trow-top{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;}
.tbar{position:relative;background:rgba(255,255,255,.05);border-radius:4px;height:10px;}
.tb-main,.tb-ach{position:absolute;border-radius:4px;}
.tb-main{height:100%;}
.tb-ach{height:4px;bottom:3px;background:var(--grn);opacity:.85;}

/* TOP CARDS */
.top-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.top-card{border-radius:10px;padding:14px;}
.top-rank{font-size:11px;color:var(--muted);margin-bottom:3px;}
.top-name{font-size:13px;color:#fff;font-weight:600;margin-bottom:2px;}
.top-mgr{font-size:11px;color:var(--muted);margin-bottom:8px;}
.top-leads{font-size:24px;font-weight:800;}
.top-cv{font-size:11px;color:var(--grn);}

/* TABLE */
.tbl-wrap{border-radius:14px;border:1px solid var(--bdr);overflow-x:auto;}
table{width:100%;border-collapse:collapse;background:var(--card);}
thead tr{background:rgba(124,92,252,.12);}
th{padding:12px 16px;text-align:left;font-size:9px;letter-spacing:2px;
  color:var(--acc);text-transform:uppercase;white-space:nowrap;}
td{padding:11px 16px;border-top:1px solid rgba(255,255,255,.04);font-size:13px;color:var(--txt);}
tr:nth-child(even) td{background:rgba(255,255,255,.015);}
.big{font-size:20px;font-weight:700;}
.cvw{display:flex;align-items:center;gap:8px;}
.cvt{width:55px;background:rgba(255,255,255,.06);border-radius:4px;height:6px;}
.cvf{border-radius:4px;height:100%;}

/* PROCESS */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.pc{background:var(--card);border-radius:14px;padding:20px;}
.pc-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;}
.pc-nums{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.pc-lbl{font-size:9px;color:var(--muted);margin-bottom:3px;}
.pc-val{font-size:24px;font-weight:800;}

/* CALENDAR */
.cal-wrap{display:grid;grid-template-columns:1fr 300px;gap:16px;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.cal-nbtn{background:rgba(124,92,252,.15);border:1px solid var(--bdr);border-radius:8px;
  color:#c4b5fd;cursor:pointer;padding:8px 14px;font-size:16px;transition:all .2s;}
.cal-nbtn:hover{background:rgba(124,92,252,.3);}
.cal-mlbl{text-align:center;}
.cal-mn{font-size:21px;font-weight:700;color:#fff;}
.cal-yr{font-size:13px;color:var(--muted);}
.cgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cdhdr{text-align:center;font-size:10px;letter-spacing:1px;color:var(--muted);padding:4px 0;}
.cday{aspect-ratio:1;display:flex;align-items:center;justify-content:center;
  border-radius:10px;cursor:pointer;font-size:14px;border:1px solid transparent;
  transition:all .12s;position:relative;}
.cday:hover{background:rgba(255,255,255,.06);transform:scale(1.08);}
.cday.has{background:rgba(124,92,252,.12);color:#c4b5fd;border-color:rgba(124,92,252,.35);}
.cday.sel{background:linear-gradient(135deg,#7c5cfc,#a78bfa);color:#fff;font-weight:700;}
.cdot{position:absolute;bottom:4px;width:4px;height:4px;border-radius:50%;background:var(--acc);}
.cal-leg{display:flex;gap:18px;margin-top:14px;justify-content:center;}
.leg{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);}
.legbox{width:12px;height:12px;border-radius:3px;}
.cal-side{display:flex;flex-direction:column;gap:14px;}
.wki{padding:10px 12px;margin-bottom:6px;background:rgba(124,92,252,.07);
  border-radius:8px;border-left:3px solid var(--acc);}
.wkn{font-size:12px;color:#c4b5fd;font-weight:600;}
.wkd{font-size:11px;color:var(--muted);margin-top:2px;}
.sel-scroll{max-height:160px;overflow-y:auto;}
.seli{display:flex;justify-content:space-between;align-items:center;
  padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px;}
.selrm{background:none;border:none;color:var(--pnk);cursor:pointer;font-size:16px;}
.btn-clr{margin-top:10px;width:100%;padding:8px;background:rgba(244,114,182,.1);
  border:1px solid rgba(244,114,182,.3);border-radius:8px;color:var(--pnk);
  cursor:pointer;font-size:12px;font-family:inherit;}

@media(max-width:960px){
  .filters,.kpis{grid-template-columns:1fr 1fr;}
  .g2,.top-grid,.pgrid,.cal-wrap{grid-template-columns:1fr;}
  .full{grid-column:1;}
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="spin"></div>
  <div id="loader-msg">CONNECTING TO GOOGLE SHEET…</div>
  <div id="err-box"></div>
</div>

<!-- HEADER -->
<header>
  <div class="hd-left">
    <small>Google Leads · Live Analytics</small>
    <h1>Lead Performance Dashboard</h1>
  </div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div class="live-pill"><span class="ldot"></span><span id="live-lbl">LIVE</span></div>
    <span id="refresh-ts"></span>
    <button class="btn-ref" onclick="loadData()">⟳ Refresh</button>
  </div>
  <div class="tabs">
    <button class="tab on"  onclick="go('overview')">Overview</button>
    <button class="tab"     onclick="go('managers')">Managers</button>
    <button class="tab"     onclick="go('counsellors')">Counsellors</button>
    <button class="tab"     onclick="go('process')">Process</button>
    <button class="tab"     onclick="go('calendar')">Calendar</button>
  </div>
</header>

<!-- FILTERS -->
<div class="filters">
  <div class="fg">
    <label>Month</label>
    <select id="fm" onchange="onMonth()"><option value="">All Months</option></select>
  </div>
  <div class="fg">
    <label>Week</label>
    <select id="fw" onchange="render()" disabled><option value="">All Weeks</option></select>
  </div>
  <div class="fg">
    <label>Manager</label>
    <select id="fmg" onchange="onMgr()"><option value="">All Managers</option></select>
  </div>
  <div class="fg">
    <label>Process</label>
    <select id="fp" onchange="render()"><option value="">All Processes</option></select>
  </div>
  <div class="fg">
    <label>Counsellor</label>
    <select id="fc" onchange="render()"><option value="">All Counsellors</option></select>
  </div>
  <div class="fg" style="display:flex;align-items:flex-end">
    <button class="btn-rst" onclick="resetF()">✕ Reset</button>
  </div>
</div>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi k1"><div class="kpi-lbl">Leads Received</div>
    <div class="kpi-val" id="kv1">—</div><div class="kpi-sub" id="ks1"></div></div>
  <div class="kpi k2"><div class="kpi-lbl">Apps Achieved</div>
    <div class="kpi-val" id="kv2">—</div><div class="kpi-sub">Applications converted</div></div>
  <div class="kpi k3"><div class="kpi-lbl">Conversion Rate</div>
    <div class="kpi-val" id="kv3">—</div><div class="kpi-sub">Received → Achieved</div></div>
  <div class="kpi k4"><div class="kpi-lbl">Active Managers</div>
    <div class="kpi-val" id="kv4">—</div><div class="kpi-sub" id="ks4"></div></div>
</div>

<!-- CONTENT -->
<div class="content">

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="g2">
      <div class="card">
        <div class="card-ttl">Manager Performance</div>
        <div id="mgr-bars"></div>
      </div>
      <div class="card">
        <div class="card-ttl">Weekly Lead Trend</div>
        <div id="trend"></div>
      </div>
      <div class="card full">
        <div class="card-ttl">Top Performing Counsellors</div>
        <div class="top-grid" id="top-cards"></div>
      </div>
    </div>
  </div>

  <!-- MANAGERS -->
  <div id="tab-managers" class="hidden">
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>Manager</th><th>Leads Received</th><th>Apps Achieved</th>
          <th>Conv %</th><th>Progress</th><th>Processes</th>
        </tr></thead>
        <tbody id="mgr-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- COUNSELLORS -->
  <div id="tab-counsellors" class="hidden">
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>Counsellor</th><th>Manager</th><th>Team Leader</th>
          <th>Received</th><th>Achieved</th><th>Conv %</th>
        </tr></thead>
        <tbody id="cnsl-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- PROCESS -->
  <div id="tab-process" class="hidden">
    <div class="pgrid" id="proc-grid"></div>
  </div>

  <!-- CALENDAR -->
  <div id="tab-calendar" class="hidden">
    <div class="cal-wrap">
      <div class="card">
        <div class="cal-nav">
          <button class="cal-nbtn" onclick="calNav(-1)">‹</button>
          <div class="cal-mlbl">
            <div class="cal-mn" id="cal-mn"></div>
            <div class="cal-yr" id="cal-yr"></div>
          </div>
          <button class="cal-nbtn" onclick="calNav(1)">›</button>
        </div>
        <div class="cgrid" id="cgrid"></div>
        <div class="cal-leg">
          <div class="leg"><div class="legbox" style="background:rgba(124,92,252,.12);border:1px solid rgba(124,92,252,.35)"></div>Has data</div>
          <div class="leg"><div class="legbox" style="background:linear-gradient(135deg,#7c5cfc,#a78bfa)"></div>Selected</div>
        </div>
      </div>
      <div class="cal-side">
        <div class="card">
          <div class="card-ttl">Week Ranges</div>
          <div id="wk-ranges"></div>
        </div>
        <div class="card" style="flex:1">
          <div class="card-ttl">Selected · <span id="sel-cnt">0</span></div>
          <div class="sel-scroll" id="sel-list"></div>
          <button class="btn-clr" id="btn-clr" onclick="clearSel()" style="display:none">Clear All</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// ── STATE ─────────────────────────────────────────────────────
var ALL = [], FOPTS = {}, CUR_TAB = "overview";
var SEL = new Set(), CAL_M = 0, CAL_Y = 2025;
var MN = ["January","February","March","April","May","June","July","August","September","October","November","December"];
var DN = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var MD = [31,28,28,31,30,31,30,31,31,30,31,30,31];
var MMETA = {
  January:{r:[[1,11],[12,18],[19,25],[26,31]]},
  February:{r:[[1,7],[8,14],[15,21],[22,28]]},
  March:{r:[[1,7]]}
};
var MC = {Aasif:"#7c5cfc",Aslam:"#34d399",Deepesh:"#f472b6","Manas Ranjan Nayak":"#fb923c"};
var PAL = ["#7c5cfc","#34d399","#f472b6","#fb923c","#60a5fa","#a78bfa","#fbbf24","#4ade80","#e879f9","#38bdf8"];

// ── LOAD ──────────────────────────────────────────────────────
window.addEventListener("DOMContentLoaded", loadData);

function loadData() {
  msg("CONNECTING TO GOOGLE SHEET…");
  document.getElementById("loader").style.display = "flex";

  if (typeof google !== "undefined" && google.script && google.script.run) {
    // ── LIVE mode via Apps Script ──
    google.script.run
      .withSuccessHandler(function(raw) {
        try {
          var opts = JSON.parse(raw);
          if (!opts.ok) { err(opts.error); return; }
          FOPTS = opts;
          fillFilters(opts);
        } catch(e) { err(e.message); return; }

        msg("LOADING LEAD DATA…");
        google.script.run
          .withSuccessHandler(function(raw2) {
            try {
              var d = JSON.parse(raw2);
              if (!d.ok) { err(d.error); return; }
              ALL = d.rows || [];
              document.getElementById("refresh-ts").textContent =
                "Updated " + new Date().toLocaleTimeString();
              go("overview");
              hide();
            } catch(e) { err(e.message); }
          })
          .withFailureHandler(err)
          .getLiveData();
      })
      .withFailureHandler(err)
      .getFilterOptions();
  } else {
    // ── PREVIEW mode (no Apps Script context) ──
    previewData();
  }
}

function msg(t){ document.getElementById("loader-msg").textContent = t; }
function hide(){ document.getElementById("loader").style.display = "none"; }
function err(e){
  var t = typeof e === "string" ? e : (e.message||JSON.stringify(e));
  document.getElementById("loader-msg").style.display = "none";
  var el = document.getElementById("err-box");
  el.innerHTML = "⚠ " + t + "<br><br><small>Make sure the script is deployed as a Web App and your sheet name is <b>Lead Data</b>.</small>";
  el.style.display = "block";
}

// ── PREVIEW DATA ──────────────────────────────────────────────
function previewData() {
  ALL = [
    {month:"January",week:"Week 4 (26th Jan-31st Jan)",counsellor:"Dominators_Google",teamLeader:"Antaryami",manager:"Aasif",process:"Alliance",leadsReceived:13,leadsAchieved:5},
    {month:"January",week:"Week 4 (26th Jan-31st Jan)",counsellor:"Kajal",teamLeader:"Kajal",manager:"Aslam",process:"Alliance",leadsReceived:13,leadsAchieved:9},
    {month:"January",week:"Week 4 (26th Jan-31st Jan)",counsellor:"Priyanka Khurde",teamLeader:"Akshay",manager:"Deepesh",process:"Alliance",leadsReceived:13,leadsAchieved:6},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Farheen",teamLeader:"Antaryami",manager:"Aasif",process:"Alliance",leadsReceived:7,leadsAchieved:4},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Vishakha Jatt",teamLeader:"Antaryami",manager:"Aasif",process:"Alliance",leadsReceived:5,leadsAchieved:2},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Ironclads_Google",teamLeader:"Kajal",manager:"Aslam",process:"Alliance",leadsReceived:13,leadsAchieved:6},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Priyanka Khurde",teamLeader:"Akshay",manager:"Deepesh",process:"Alliance",leadsReceived:13,leadsAchieved:6},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Manas Tawate",teamLeader:"Akshay",manager:"Deepesh",process:"Presidency",leadsReceived:22,leadsAchieved:3},
    {month:"February",week:"Week 1 (1st Feb- 7th Feb)",counsellor:"Devashish",teamLeader:"Devashish",manager:"Deepesh",process:"Alliance",leadsReceived:12,leadsAchieved:5},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Farheen",teamLeader:"Ruthvik",manager:"Aasif",process:"Alliance",leadsReceived:12,leadsAchieved:6},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Ironclads_Google",teamLeader:"Kajal",manager:"Aslam",process:"Alliance",leadsReceived:10,leadsAchieved:4},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Yashwant",teamLeader:"Yashwant",manager:"Aslam",process:"Presidency",leadsReceived:7,leadsAchieved:2},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Manas Tawate",teamLeader:"Akshay",manager:"Deepesh",process:"Presidency",leadsReceived:8,leadsAchieved:2},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Priyanka Khurde",teamLeader:"Akshay",manager:"Deepesh",process:"Alliance",leadsReceived:10,leadsAchieved:5},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Devashish",teamLeader:"Devashish",manager:"Deepesh",process:"Alliance",leadsReceived:8,leadsAchieved:3},
    {month:"February",week:"Week 2 (8th Feb- 14th Feb)",counsellor:"Sekhara Kumar Sethi",teamLeader:"Manas Ranjan Nayak",manager:"Manas Ranjan Nayak",process:"Alliance",leadsReceived:4,leadsAchieved:1},
    {month:"February",week:"Week 3 (15th Feb- 21st Feb)",counsellor:"Manas Tawate",teamLeader:"Akshay",manager:"Deepesh",process:"Presidency",leadsReceived:20,leadsAchieved:0}
  ];
  var u = {months:["January","February"],weeksByMonth:{January:["Week 4 (26th Jan-31st Jan)"],February:["Week 1 (1st Feb- 7th Feb)","Week 2 (8th Feb- 14th Feb)","Week 3 (15th Feb- 21st Feb)"]},managers:["Aasif","Aslam","Deepesh","Manas Ranjan Nayak"],processes:["Alliance","Presidency"],counsellors:[...new Set(ALL.map(function(d){return d.counsellor;}))]};
  FOPTS = u;
  fillFilters(u);
  document.getElementById("live-lbl").textContent = "PREVIEW";
  document.getElementById("refresh-ts").textContent = "(no Apps Script — showing sample data)";
  go("overview");
  hide();
}

// ── FILTERS ───────────────────────────────────────────────────
function fillFilters(o) {
  function add(id, arr) {
    var s = document.getElementById(id);
    (arr||[]).forEach(function(v){ var op=document.createElement("option"); op.value=v; op.textContent=v; s.appendChild(op); });
  }
  add("fm", o.months); add("fmg", o.managers); add("fp", o.processes); add("fc", o.counsellors);
}
function onMonth() {
  var m = document.getElementById("fm").value;
  var ws = document.getElementById("fw");
  ws.innerHTML = "<option value=''>All Weeks</option>";
  ws.disabled = !m;
  if (m && FOPTS.weeksByMonth && FOPTS.weeksByMonth[m]) {
    FOPTS.weeksByMonth[m].forEach(function(w){ var o=document.createElement("option"); o.value=w; o.textContent=w; ws.appendChild(o); });
  }
  render();
}
function onMgr() {
  var mg = document.getElementById("fmg").value;
  var cs = document.getElementById("fc");
  cs.innerHTML = "<option value=''>All Counsellors</option>";
  var list = mg ? [...new Set(ALL.filter(function(d){return d.manager===mg;}).map(function(d){return d.counsellor;}))] : (FOPTS.counsellors||[]);
  list.sort().forEach(function(c){ var o=document.createElement("option"); o.value=c; o.textContent=c; cs.appendChild(o); });
  render();
}
function resetF() {
  ["fm","fw","fmg","fp","fc"].forEach(function(id){ document.getElementById(id).value=""; });
  document.getElementById("fw").disabled = true;
  render();
}

// ── DATA ──────────────────────────────────────────────────────
function filtered() {
  var m=v("fm"),w=v("fw"),mg=v("fmg"),p=v("fp"),c=v("fc");
  return ALL.filter(function(d){
    return(!m||d.month===m)&&(!w||d.week===w)&&(!mg||d.manager===mg)&&(!p||d.process===p)&&(!c||d.counsellor===c);
  });
}
function agg(data, key) {
  var map={};
  data.forEach(function(d){
    var k=d[key]; if(!k) return;
    if(!map[k]) map[k]={name:k,r:0,a:0,mgr:d.manager,tl:d.teamLeader,procs:{},mgrs:{}};
    map[k].r+=d.leadsReceived; map[k].a+=d.leadsAchieved;
    map[k].procs[d.process]=1; map[k].mgrs[d.manager]=1;
  });
  return Object.values(map).map(function(x){
    return Object.assign({},x,{
      procs:Object.keys(x.procs), mgrs:Object.keys(x.mgrs),
      ratio:x.r>0?((x.a/x.r)*100).toFixed(1):"0.0"
    });
  }).sort(function(a,b){return b.r-a.r;});
}
function v(id){ return document.getElementById(id).value; }

// ── RENDER ────────────────────────────────────────────────────
function render() {
  var data=filtered();
  var tR=data.reduce(function(s,d){return s+d.leadsReceived;},0);
  var tA=data.reduce(function(s,d){return s+d.leadsAchieved;},0);
  var cv=tR>0?((tA/tR)*100).toFixed(1):"0.0";
  var mgrs=agg(data,"manager");
  set("kv1",tR); set("ks1",data.length+" records");
  set("kv2",tA); set("kv3",cv+"%");
  set("kv4",mgrs.filter(function(m){return m.r>0;}).length);
  set("ks4","of "+mgrs.length+" managers");
  if(CUR_TAB==="overview")    rOverview(data,mgrs,tR);
  if(CUR_TAB==="managers")    rManagers(data,mgrs);
  if(CUR_TAB==="counsellors") rCounsellors(data);
  if(CUR_TAB==="process")     rProcess(data);
  if(CUR_TAB==="calendar")    rCalendar();
}

// ── OVERVIEW ──────────────────────────────────────────────────
function rOverview(data,mgrs,tR) {
  // Manager bars
  var h="";
  mgrs.forEach(function(m){
    var c=MC[m.name]||"#888", pct=tR>0?(m.r/tR)*100:0;
    h+='<div class="brow"><div class="brow-top">'
     +'<span class="brow-name"><span class="dot8" style="background:'+c+'"></span>'+xe(m.name)+'</span>'
     +'<span class="brow-bdgs">'
     +'<span class="bdg" style="background:'+c+'22;color:'+c+';border:1px solid '+c+'44">'+m.r+' leads</span>'
     +'<span class="bdg" style="background:rgba(52,211,153,.12);color:#34d399;border:1px solid rgba(52,211,153,.3)">'+m.ratio+'%</span>'
     +'</span></div>'
     +'<div class="trk trk7"><div class="trk-fill" style="width:'+pct+'%;background:linear-gradient(90deg,'+c+','+c+'88)"></div></div>'
     +'<div class="trk3"><div class="trk3-fill" style="width:'+m.ratio+'%"></div></div>'
     +'</div>';
  });
  set("mgr-bars", h||nd());

  // Trend
  var tm={};
  data.forEach(function(d){
    var k=d.month+"|"+d.week, lbl=d.month.slice(0,3)+" "+d.week.match(/Week \d+/)[0];
    if(!tm[k])tm[k]={l:lbl,r:0,a:0}; tm[k].r+=d.leadsReceived; tm[k].a+=d.leadsAchieved;
  });
  var tr=Object.values(tm).filter(function(t){return t.r>0;});
  var mx=Math.max.apply(null,tr.map(function(t){return t.r;}).concat([1]));
  var th="";
  tr.forEach(function(t,i){
    var c=PAL[i%PAL.length];
    th+='<div class="trow"><div class="trow-top"><span style="color:var(--muted)">'+t.l+'</span>'
     +'<span>'+t.r+' <span style="color:var(--muted)">rcv</span> · <span style="color:#34d399">'+t.a+'</span> <span style="color:var(--muted)">ach</span></span></div>'
     +'<div class="tbar"><div class="tb-main" style="width:'+(t.r/mx*100)+'%;background:linear-gradient(90deg,'+c+',#a78bfa)"></div>'
     +'<div class="tb-ach" style="width:'+(t.a/mx*100)+'%"></div></div></div>';
  });
  set("trend", th||nd());

  // Top counsellors
  var top=agg(data,"counsellor").filter(function(c){return c.r>0;}).slice(0,5);
  var ch="";
  top.forEach(function(c,i){
    var col=MC[c.mgr]||"#888";
    ch+='<div class="top-card" style="background:'+col+'11;border:1px solid '+col+'33">'
     +'<div class="top-rank">#'+(i+1)+'</div><div class="top-name">'+xe(c.name)+'</div>'
     +'<div class="top-mgr">'+xe(c.mgr)+'</div>'
     +'<div class="top-leads" style="color:'+col+'">'+c.r+'</div>'
     +'<div class="top-cv">'+c.ratio+'% conv.</div></div>';
  });
  set("top-cards", ch||nd());
}

// ── MANAGERS TABLE ────────────────────────────────────────────
function rManagers(data,mgrs) {
  var h="";
  mgrs.forEach(function(m){
    var c=MC[m.name]||"#888", rc=+m.ratio>=40?"#34d399":"#f472b6";
    var ps=m.procs.slice(0,4).map(function(p){
      return '<span class="bdg" style="background:rgba(122,111,160,.12);color:var(--muted);border:1px solid rgba(122,111,160,.2)">'+xe(p)+'</span>';
    }).join(" ")+(m.procs.length>4?'<span class="bdg" style="background:rgba(122,111,160,.12);color:var(--muted);border:1px solid rgba(122,111,160,.2)">+'+(m.procs.length-4)+'</span>':"");
    h+='<tr>'
     +'<td><span style="display:inline-flex;align-items:center;gap:8px"><span style="width:10px;height:10px;border-radius:50%;background:'+c+';display:inline-block"></span>'+xe(m.name)+'</span></td>'
     +'<td class="big" style="color:'+c+'">'+m.r+'</td>'
     +'<td class="big" style="color:#34d399">'+m.a+'</td>'
     +'<td><span class="bdg" style="background:'+rc+'22;color:'+rc+';border:1px solid '+rc+'44">'+m.ratio+'%</span></td>'
     +'<td><div class="cvw"><div class="cvt"><div class="cvf" style="width:'+m.ratio+'%;background:linear-gradient(90deg,'+c+',#34d399)"></div></div></div></td>'
     +'<td>'+ps+'</td></tr>';
  });
  set("mgr-tbody", h);
}

// ── COUNSELLORS TABLE ─────────────────────────────────────────
function rCounsellors(data) {
  var stats=agg(data,"counsellor");
  var h="";
  stats.forEach(function(c,i){
    var col=MC[c.mgr]||"#888", rc=+c.ratio>=40?"#34d399":"#f472b6";
    h+='<tr>'
     +'<td style="color:var(--muted)">'+(i+1)+'</td>'
     +'<td style="font-weight:600;color:#fff">'+xe(c.name)+'</td>'
     +'<td><span class="bdg" style="background:'+col+'22;color:'+col+';border:1px solid '+col+'44">'+xe(c.mgr)+'</span></td>'
     +'<td style="color:var(--muted);font-size:12px">'+xe(c.tl||"")+'</td>'
     +'<td class="big" style="color:'+col+'">'+c.r+'</td>'
     +'<td class="big" style="color:#34d399">'+c.a+'</td>'
     +'<td><div class="cvw"><div class="cvt"><div class="cvf" style="width:'+c.ratio+'%;background:'+rc+'"></div></div>'
     +'<span style="font-size:12px;color:'+rc+';font-weight:600;min-width:40px">'+c.ratio+'%</span></div></td>'
     +'</tr>';
  });
  set("cnsl-tbody", h);
}

// ── PROCESS ───────────────────────────────────────────────────
function rProcess(data) {
  var stats=agg(data,"process");
  var mx=Math.max.apply(null,stats.map(function(s){return s.r;}).concat([1]));
  var h="";
  stats.forEach(function(p,i){
    var c=PAL[i%PAL.length], rc=+p.ratio>=40?"#34d399":"#f472b6";
    h+='<div class="pc" style="border:1px solid '+c+'33">'
     +'<div class="pc-hdr"><div style="font-size:16px;font-weight:700;color:#fff">'+xe(p.name)+'</div>'
     +'<span class="bdg" style="background:'+rc+'22;color:'+rc+';border:1px solid '+rc+'44">'+p.ratio+'%</span></div>'
     +'<div class="pc-nums">'
     +'<div><div class="pc-lbl">RECEIVED</div><div class="pc-val" style="color:'+c+'">'+p.r+'</div></div>'
     +'<div><div class="pc-lbl">ACHIEVED</div><div class="pc-val" style="color:#34d399">'+p.a+'</div></div>'
     +'<div><div class="pc-lbl">COUNSELLORS</div><div style="font-size:18px">'+p.procs.length+'</div></div>'
     +'<div><div class="pc-lbl">MANAGERS</div><div style="font-size:18px">'+p.mgrs.length+'</div></div>'
     +'</div>'
     +'<div style="background:rgba(255,255,255,.05);border-radius:4px;height:6px">'
     +'<div style="width:'+(p.r/mx*100)+'%;background:linear-gradient(90deg,'+c+','+c+'88);border-radius:4px;height:100%"></div></div>'
     +'</div>';
  });
  set("proc-grid", h||nd());
}

// ── CALENDAR ──────────────────────────────────────────────────
function rCalendar() {
  var mn=MN[CAL_M];
  set("cal-mn",mn); set("cal-yr",CAL_Y);
  var meta=MMETA[mn], act=new Set();
  if(meta) meta.r.forEach(function(r){for(var d=r[0];d<=r[1];d++)act.add(d);});
  var fd=new Date(CAL_Y,CAL_M,1).getDay(), dim=MD[CAL_M];
  var h=DN.map(function(d){return'<div class="cdhdr">'+d+'</div>';}).join("");
  for(var i=0;i<fd;i++) h+="<div></div>";
  for(var day=1;day<=dim;day++){
    var key=CAL_Y+"-"+CAL_M+"-"+day;
    var isSel=SEL.has(key), isAct=act.has(day);
    var wk=wkForDay(mn,day);
    var cls="cday"+(isSel?" sel":isAct?" has":"");
    var dot=(isAct&&!isSel)?'<span class="cdot"></span>':"";
    h+='<div class="'+cls+'" onclick="togDay('+day+')" title="'+(wk||"")+'">'+day+dot+'</div>';
  }
  set("cgrid",h);
  // week ranges
  var wh="";
  if(meta) meta.r.forEach(function(r,i){wh+='<div class="wki"><div class="wkn">Week '+(i+1)+'</div><div class="wkd">'+r[0]+'–'+r[1]+' '+mn+'</div></div>';});
  else wh='<div style="color:var(--muted);font-size:13px">No data for this month</div>';
  set("wk-ranges",wh);
  // selected list
  var sel=[...SEL].sort();
  set("sel-cnt",sel.length);
  document.getElementById("btn-clr").style.display=sel.length?"":"none";
  var sh="";
  sel.forEach(function(k){
    var p=k.split("-");
    sh+='<div class="seli"><span>'+(MN[+p[1]]||p[1])+' '+p[2]+', '+p[0]+'</span>'
      +'<button class="selrm" onclick="remDay(\''+k+'\')">×</button></div>';
  });
  set("sel-list",sh||'<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px 0">Click days to select</div>');
}
function wkForDay(mn,d){ var m=MMETA[mn]; if(!m) return null; var i=m.r.findIndex(function(r){return d>=r[0]&&d<=r[1];}); return i>=0?"Week "+(i+1):null; }
function togDay(d){ var k=CAL_Y+"-"+CAL_M+"-"+d; SEL.has(k)?SEL.delete(k):SEL.add(k); rCalendar(); }
function remDay(k){ SEL.delete(k); rCalendar(); }
function clearSel(){ SEL.clear(); rCalendar(); }
function calNav(dir){ CAL_M+=dir; if(CAL_M<0){CAL_M=11;CAL_Y--;}else if(CAL_M>11){CAL_M=0;CAL_Y++;} rCalendar(); }

// ── TAB SWITCH ────────────────────────────────────────────────
function go(t) {
  document.querySelectorAll("[id^='tab-']").forEach(function(el){el.classList.add("hidden");});
  document.getElementById("tab-"+t).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(function(b){
    b.classList.toggle("on", b.getAttribute("onclick").indexOf("'"+t+"'")>=0);
  });
  CUR_TAB=t; render();
}

// ── UTILS ─────────────────────────────────────────────────────
function set(id,v){ var el=document.getElementById(id); if(el) el.innerHTML=v; }
function nd(){ return '<div class="no-data">No data for current filters</div>'; }
function xe(s){ var d=document.createElement("div"); d.textContent=s||""; return d.innerHTML; }
</script>
</body>
</html>
