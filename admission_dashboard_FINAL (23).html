<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>higher.study Â· Admissions Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET + ROOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#08091a;
  --card:rgba(255,255,255,.05);
  --brd:rgba(255,255,255,.08);
  --accent:#c94e2d;
  --accent2:#e07050;
  --font:'Plus Jakarta Sans',sans-serif;
}
html{scroll-behavior:smooth;overscroll-behavior:none;}
body{-webkit-overflow-scrolling:touch;}
body{
  font-family:var(--font);
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
  -webkit-tap-highlight-color:transparent;
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 90% 55% at 50% -10%,rgba(99,72,255,.36) 0%,transparent 62%),
    radial-gradient(ellipse 50% 40% at 100% 100%,rgba(6,182,212,.08) 0%,transparent 55%),
    radial-gradient(ellipse 40% 30% at 0% 80%,rgba(139,92,246,.06) 0%,transparent 50%);
  /* Own compositor layer â€” no repaint on scroll */
  transform:translateZ(0);will-change:transform;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ldr{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:9999;gap:14px;
  transition:opacity .4s ease;
}
#ldr.out{opacity:0;pointer-events:none;}
.ldr-ring{
  width:52px;height:52px;border-radius:50%;
  border:3px solid rgba(201,78,45,.15);
  border-top-color:#c94e2d;
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.ldr-ico{position:absolute;font-size:22px;}
.ldr-wrap{position:relative;width:52px;height:52px;display:flex;align-items:center;justify-content:center;}
.ldr-txt{font-size:11px;font-weight:700;color:rgba(255,255,255,.2);letter-spacing:.18em;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap{
  position:relative;z-index:1;
  max-width:1200px;margin:0 auto;
  padding:18px 20px 40px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;gap:10px;flex-wrap:wrap;
}
.brand{display:flex;align-items:center;gap:12px;}
.brand-ico{
  width:44px;height:44px;border-radius:12px;flex-shrink:0;
  background:linear-gradient(135deg,#c94e2d,#e07050);
  display:flex;align-items:center;justify-content:center;
  font-size:22px;box-shadow:0 4px 18px rgba(201,78,45,.4);
}
.brand-title{font-size:clamp(14px,1.8vw,20px);font-weight:800;letter-spacing:-.025em;line-height:1.2;}
.brand-sub{font-size:10px;font-weight:600;color:rgba(255,255,255,.28);letter-spacing:.07em;margin-top:2px;}
.top-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}

/* Tabs */
.tabs{
  display:flex;background:rgba(255,255,255,.06);
  border:1px solid var(--brd);border-radius:12px;padding:3px;gap:2px;
}
.tab{
  padding:6px 13px;border-radius:9px;font-size:12px;font-weight:700;
  cursor:pointer;color:rgba(255,255,255,.32);border:none;background:transparent;
  font-family:var(--font);transition:all .15s ease;user-select:none;white-space:nowrap;
}
.tab.on{background:rgba(255,255,255,.95);color:#08091a;font-weight:800;}
.tab:hover:not(.on){color:rgba(255,255,255,.72);background:rgba(255,255,255,.08);}
.tab:active:not(.on){transform:scale(.96);}

/* Cal button */
.cal-btn{
  display:flex;align-items:center;gap:6px;
  padding:7px 13px;border-radius:10px;
  border:1px solid var(--brd);background:rgba(255,255,255,.06);
  cursor:pointer;font-size:12px;font-weight:700;color:rgba(255,255,255,.5);
  font-family:var(--font);transition:all .15s ease;white-space:nowrap;user-select:none;
}
.cal-btn:hover{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.15);}
.cal-btn.active{background:rgba(201,78,45,.18);border-color:rgba(201,78,45,.45);color:#f87c5e;}
.ava{
  width:36px;height:36px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,#6366f1,#06b6d4);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:13px;
  box-shadow:0 0 0 2px rgba(99,102,241,.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.statusbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;flex-wrap:wrap;gap:8px;
}
.live-wrap{display:flex;align-items:center;gap:6px;}
.live-dot{
  width:7px;height:7px;border-radius:50%;
  background:#10b981;box-shadow:0 0 6px rgba(16,185,129,.6);
  animation:pulse 2s infinite;
}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.75)}}
.live-txt{font-size:11px;font-weight:600;color:rgba(255,255,255,.22);letter-spacing:.03em;}
.kpis{display:flex;gap:8px;flex-wrap:wrap;}
.kpi{
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.055);border:1px solid var(--brd);
  border-radius:22px;padding:5px 14px;
  transition:background .2s;
}
.kpi:hover{background:rgba(255,255,255,.08);}
.kpi-lbl{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:.06em;}
.kpi-val{font-size:13px;font-weight:800;transition:color .3s;}
.kpi.net .kpi-val{color:#67e8f9;}
.kpi.tot .kpi-val{color:#fff;}
.kpi.can .kpi-val{color:#fca5a5;}
.range-badge{
  display:none;align-items:center;gap:5px;
  background:rgba(201,78,45,.12);border:1px solid rgba(201,78,45,.3);
  border-radius:20px;padding:4px 10px;
  font-size:11px;font-weight:700;color:#f87c5e;white-space:nowrap;
}
.range-badge.show{display:flex;}
.rbx{cursor:pointer;opacity:.6;margin-left:2px;font-size:14px;transition:opacity .15s;}
.rbx:hover{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRID + CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;align-items:stretch;}
@media(max-width:660px){.g2{grid-template-columns:1fr;}}

.card,.full-card{
  background:var(--card);border:1px solid var(--brd);
  border-radius:18px;padding:20px;
  contain:layout style paint;
  transition:box-shadow .25s ease,border-color .25s ease;
}
/* University card is a flex column â€” see .card.univ-card rule in DONUT section */
.card:hover,.full-card:hover{
  box-shadow:0 8px 32px rgba(0,0,0,.28);
  border-color:rgba(255,255,255,.12);
}
.full-card{margin-bottom:14px;}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-size:14px;font-weight:800;letter-spacing:-.01em;}
.card-badge{
  font-size:10px;font-weight:700;color:rgba(255,255,255,.3);
  background:rgba(255,255,255,.07);border:1px solid var(--brd);
  border-radius:20px;padding:2px 9px;letter-spacing:.03em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANAGER / TL BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.barlist{display:flex;flex-direction:column;gap:10px;}
.br-wrap{display:flex;flex-direction:column;gap:3px;}

.br{
  display:flex;align-items:center;gap:9px;
  cursor:pointer;border-radius:8px;
  transition:opacity .18s ease;
  padding:2px 0;
}
.br:hover{opacity:.88;}
.br.active-mgr .bf{box-shadow:0 0 0 2px rgba(255,255,255,.35) inset;}
.br.dimmed{opacity:.25;}

.bn{width:74px;font-size:13px;font-weight:700;flex-shrink:0;color:rgba(255,255,255,.85);}
.bt{flex:1;height:32px;position:relative;}
.bt-bg{position:absolute;inset:0;background:rgba(255,255,255,.055);border-radius:8px;}
.bf{
  position:absolute;top:0;left:0;height:100%;width:100%;
  border-radius:8px;transform:scaleX(0);transform-origin:left;
  transition:transform .85s cubic-bezier(.16,1,.3,1);
  will-change:transform;
}
.bl{
  position:absolute;top:50%;left:10px;transform:translateY(-50%);
  display:flex;align-items:center;
  background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.14);
  border-radius:20px;padding:3px 10px;
  font-size:12px;font-weight:800;color:#fff;
  white-space:nowrap;pointer-events:none;z-index:5;
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
}
.bv{width:32px;text-align:right;font-size:13px;font-weight:800;color:rgba(255,255,255,.4);flex-shrink:0;}

/* Bar colors */
.c1{background:linear-gradient(90deg,#3730a3,#818cf8);}
.c2{background:linear-gradient(90deg,#0e7490,#22d3ee);}
.c3{background:linear-gradient(90deg,#5b21b6,#c084fc);}
.c4{background:linear-gradient(90deg,#065f46,#34d399);}
.c5{background:linear-gradient(90deg,#9d174d,#f472b6);}

/* Target bar */
.br-target{
  display:none;align-items:center;gap:9px;
  animation:fadeUp .2s ease both;
}
.br-target.show{display:flex;}
.bn-tgt{width:74px;font-size:9px;font-weight:700;color:rgba(251,191,36,.55);flex-shrink:0;letter-spacing:.04em;text-transform:uppercase;}
.bt-tgt{
  flex:1;height:13px;background:rgba(255,255,255,.04);
  border-radius:4px;overflow:visible;position:relative;
  border:1px solid rgba(255,255,255,.07);
}
.bf-tgt{
  height:100%;border-radius:4px;position:relative;
  transform:scaleX(0);transform-origin:left;
  transition:transform .9s cubic-bezier(.16,1,.3,1);
  will-change:transform;
  background:repeating-linear-gradient(
    -45deg,
    rgba(255,255,255,.08) 0px,rgba(255,255,255,.08) 3px,
    transparent 3px,transparent 8px
  );
}
.bf-tgt::after{
  content:'';position:absolute;inset:0;border-radius:4px;
  background:linear-gradient(90deg,rgba(251,191,36,.55),rgba(251,191,36,.15));
}
.bt-tgt-lbl{
  position:absolute;right:6px;top:50%;transform:translateY(-50%);
  font-size:9px;font-weight:800;color:rgba(251,191,36,.9);
  letter-spacing:.04em;white-space:nowrap;pointer-events:none;z-index:2;
}
.bv-tgt{width:28px;text-align:right;font-size:10px;font-weight:800;color:rgba(251,191,36,.65);flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DONUT CHART â€” fills full card height, no dead space
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Card itself stretches to match its grid sibling */
.card.univ-card{
  display:flex;flex-direction:column;
  /* Remove paint containment â€” it clips flex children growing to full height */
  contain:layout style;
}

/* donut-wrap fills remaining card height after the header */
.donut-wrap{
  display:flex;align-items:stretch;
  gap:0;width:100%;flex:1;
  min-height:148px;
}

/* Donut box â€” fixed width, SVG centered vertically */
.donut-box{
  position:relative;flex-shrink:0;
  width:148px;min-height:148px;
  display:flex;align-items:center;justify-content:center;
  align-self:center;
}
.donut-ctr{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);text-align:center;pointer-events:none;
}
.donut-num{
  font-size:28px;font-weight:900;line-height:1;letter-spacing:-.03em;
  background:linear-gradient(135deg,#fff 55%,rgba(255,255,255,.55));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.donut-sub{
  font-size:8px;font-weight:700;color:rgba(255,255,255,.28);
  letter-spacing:.15em;margin-top:5px;display:block;text-transform:uppercase;
}
#u1,#u2,#u3,#u4,#u5,#u6{
  transition:stroke-dasharray .55s cubic-bezier(.16,1,.3,1),
             stroke-dashoffset .55s cubic-bezier(.16,1,.3,1);
  will-change:stroke-dasharray,stroke-dashoffset;
}

/* Legend â€” stretches full height, rows space-evenly to fill it */
.leg{
  flex:1;min-width:0;padding-left:18px;
  display:flex;flex-direction:column;
  justify-content:space-evenly;  /* rows spread to fill whatever height exists */
}
.leg-row{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:5px 10px;border-radius:8px;transition:background .12s;cursor:default;
  flex:1;max-height:42px;        /* cap so rows don't balloon on very tall cards */
}
.leg-row:hover{background:rgba(255,255,255,.055);}
.leg-l{display:flex;align-items:center;gap:9px;min-width:0;flex:1;}
.leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.leg-name{
  font-size:12.5px;font-weight:600;color:rgba(255,255,255,.72);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;
}
.leg-pct{
  font-size:10px;font-weight:700;color:rgba(255,255,255,.2);
  min-width:32px;text-align:right;flex-shrink:0;
}
.leg-val{
  font-size:14px;font-weight:900;
  min-width:28px;text-align:right;flex-shrink:0;letter-spacing:-.02em;
}
.univ-filter-tag{
  display:none;align-items:center;gap:6px;font-size:10px;font-weight:700;
  color:rgba(255,255,255,.45);margin-top:10px;
}
.univ-filter-tag.show{display:flex;}
.univ-filter-name{color:#fff;}
.univ-filter-x{cursor:pointer;opacity:.5;font-size:13px;line-height:1;transition:opacity .15s;margin-left:2px;}
.univ-filter-x:hover{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP PERFORMERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tlist{display:flex;flex-direction:column;gap:10px;}
.ti{
  display:flex;align-items:center;gap:13px;
  border-radius:14px;padding:14px 15px;
  transition:transform .15s ease;cursor:default;
}
.ti:hover{transform:translateX(4px);}
.ti.r1{background:linear-gradient(135deg,rgba(250,204,21,.14),rgba(250,204,21,.02));border:1px solid rgba(250,204,21,.22);}
.ti.r2{background:linear-gradient(135deg,rgba(99,102,241,.14),rgba(99,102,241,.02));border:1px solid rgba(99,102,241,.22);}
.ti.r3{background:linear-gradient(135deg,rgba(236,72,153,.14),rgba(236,72,153,.02));border:1px solid rgba(236,72,153,.22);}
.t-ico{font-size:26px;flex-shrink:0;line-height:1;}
.t-body{flex:1;min-width:0;}
.t-role{font-size:9px;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.28);margin-bottom:3px;display:block;}
.t-name{font-size:16px;font-weight:800;display:block;letter-spacing:-.015em;}
.t-right{flex-shrink:0;text-align:right;}
.t-num{font-size:26px;font-weight:900;line-height:1;letter-spacing:-.025em;display:block;}
.t-lbl{font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.22);display:block;margin-top:3px;}
.ti.r1 .t-num{color:#fde047;}
.ti.r2 .t-num{color:#a5b4fc;}
.ti.r3 .t-num{color:#f9a8d4;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TREND CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.trend-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap;gap:8px;}
.trend-filters{display:flex;gap:5px;}
.tf{
  padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
  cursor:pointer;border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);color:rgba(255,255,255,.38);
  font-family:var(--font);transition:all .15s ease;user-select:none;
}
.tf:hover{color:#fff;}
.tf.on{background:rgba(99,102,241,.2);border-color:rgba(99,102,241,.5);color:#a5b4fc;}
.trend-stats{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:16px;}
.tstat-val{font-size:22px;font-weight:900;letter-spacing:-.02em;line-height:1;}
.tstat-lbl{font-size:9px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:.06em;margin-top:2px;}
.tstat.up .tstat-val{color:#34d399;}
.tstat.dn .tstat-val{color:#f87171;}
.tstat.neu .tstat-val{color:#a5b4fc;}
.chart-wrap{position:relative;height:200px;}
.chart-svg{width:100%;height:100%;overflow:visible;}
.chart-tip{
  position:absolute;pointer-events:none;opacity:0;
  transition:opacity .12s;
  background:rgba(14,15,35,.96);border:1px solid rgba(255,255,255,.12);
  border-radius:10px;padding:9px 14px;font-size:12px;font-weight:700;
  white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.5);z-index:10;
}
.tt-date{font-size:10px;color:rgba(255,255,255,.35);margin-bottom:3px;font-weight:600;}
.tt-val{font-size:17px;font-weight:900;color:#a5b4fc;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COUNSELLOR GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.counsel-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
.counsel-head-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.counsel-search{
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);
  border-radius:8px;padding:5px 10px;transition:border-color .15s;
}
.counsel-search:focus-within{border-color:rgba(255,255,255,.22);}
.counsel-search input{
  background:transparent;border:none;outline:none;
  color:#fff;font-size:11px;font-weight:600;
  font-family:var(--font);width:130px;
}
.counsel-search input::placeholder{color:rgba(255,255,255,.22);}
.c-podium-wrap{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.c-pod{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px 10px 12px;border-radius:40px;
  flex:1;min-width:180px;
  transition:transform .15s ease;cursor:default;
}
.c-pod:hover{transform:translateY(-2px);}
.c-pod.p1{background:linear-gradient(90deg,rgba(250,204,21,.16),rgba(250,204,21,.04));border:1px solid rgba(250,204,21,.3);}
.c-pod.p2{background:linear-gradient(90deg,rgba(148,163,184,.12),rgba(148,163,184,.03));border:1px solid rgba(148,163,184,.2);}
.c-pod.p3{background:linear-gradient(90deg,rgba(180,107,60,.12),rgba(180,107,60,.03));border:1px solid rgba(180,107,60,.2);}
.c-pod-ico{font-size:20px;flex-shrink:0;line-height:1;}
.c-pod-body{flex:1;min-width:0;}
.c-pod-name{font-size:13px;font-weight:800;color:#fff;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.3;}
.c-pod-lbl{font-size:9px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:.1em;text-transform:uppercase;display:block;margin-top:2px;}
.c-pod-stats{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;gap:2px;}
.c-pod-num{font-size:22px;font-weight:900;line-height:1;flex-shrink:0;}
.p1 .c-pod-num{color:#fde047;}
.p2 .c-pod-num{color:#cbd5e1;}
.p3 .c-pod-num{color:#c47a3c;}
.c-pod-inc{font-size:11px;font-weight:800;color:#10b981;letter-spacing:.02em;}
.c-grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
}
@media(max-width:1000px){.c-grid{grid-template-columns:repeat(4,1fr);}}
@media(max-width:700px){.c-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:450px){.c-grid{grid-template-columns:repeat(2,1fr);}}
.cg-card{
  position:relative;overflow:hidden;
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  transition:transform .15s ease,box-shadow .15s ease;
  cursor:default;
}
.cg-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3);}
.cg-card.has-inc{padding:11px 12px;}
.cg-fill{
  position:absolute;top:0;left:0;height:100%;
  transform:scaleX(0);transform-origin:left;
  transition:transform 1s cubic-bezier(.16,1,.3,1);
  will-change:transform;z-index:0;border-radius:10px;
}
.cg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;position:relative;z-index:1;}
.cg-body{flex:1;min-width:0;position:relative;z-index:1;}
.cg-name{font-size:12px;font-weight:700;color:#fff;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.3;}
.cg-inc{font-size:9px;font-weight:800;display:block;margin-top:2px;letter-spacing:.03em;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cg-right{text-align:right;flex-shrink:0;position:relative;z-index:1;}
.cg-count{font-size:16px;font-weight:900;line-height:1;display:block;color:#fff;}
.cg-pct{font-size:9px;font-weight:700;color:rgba(255,255,255,.5);display:block;margin-top:1px;letter-spacing:.04em;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INCENTIVE LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inc-section{
  border-radius:18px;margin-top:14px;
  background:linear-gradient(135deg,rgba(16,185,129,.09),rgba(6,182,212,.04));
  border:1px solid rgba(16,185,129,.2);
  padding:18px 20px;position:relative;overflow:hidden;
}
.inc-section::before{
  content:'';position:absolute;top:-70px;right:-70px;width:240px;height:240px;
  border-radius:50%;background:radial-gradient(circle,rgba(16,185,129,.12),transparent 62%);
  pointer-events:none;
}
.inc-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;position:relative;z-index:1;}
.inc-head-title{font-size:14px;font-weight:900;color:#fff;letter-spacing:-.02em;}
.inc-head-sub{font-size:10px;font-weight:600;color:rgba(255,255,255,.3);margin-top:2px;}
.inc-total-pill{
  background:rgba(16,185,129,.18);border:1px solid rgba(16,185,129,.38);
  border-radius:22px;padding:5px 16px;
  font-size:15px;font-weight:900;color:#10b981;
  box-shadow:0 0 18px rgba(16,185,129,.18);
}
.inc-chart{display:flex;flex-direction:column;gap:9px;position:relative;z-index:1;}
.inc-row{display:flex;align-items:center;gap:10px;}
.inc-rank{
  width:26px;height:26px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:900;
}
.inc-rank.r1{background:rgba(253,224,71,.22);color:#fde047;border:1px solid rgba(253,224,71,.35);}
.inc-rank.r2{background:rgba(226,232,240,.12);color:#e2e8f0;border:1px solid rgba(226,232,240,.18);}
.inc-rank.r3{background:rgba(245,158,11,.2);color:#fbbf24;border:1px solid rgba(245,158,11,.28);}
.inc-rank.rn{background:rgba(255,255,255,.06);color:rgba(255,255,255,.38);border:1px solid rgba(255,255,255,.08);}
.inc-name{width:98px;flex-shrink:0;}
.inc-name-main{font-size:12px;font-weight:800;color:#fff;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.inc-name-adm{font-size:10px;font-weight:700;color:rgba(255,255,255,.35);display:block;margin-top:1px;}
.inc-track-wrap{flex:1;position:relative;height:40px;}
.inc-track{width:100%;height:100%;background:rgba(255,255,255,.055);border-radius:10px;overflow:hidden;position:relative;}
.inc-bar{
  position:absolute;top:0;left:0;height:100%;width:100%;
  border-radius:10px;transform:scaleX(0);transform-origin:left;
  transition:transform 1.1s cubic-bezier(.16,1,.3,1);
  will-change:transform;
}
.inc-bar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,.05) 0%,rgba(255,255,255,.16) 60%,rgba(255,255,255,.05) 100%);border-radius:10px;}
.inc-bar::before{
  content:'';position:absolute;top:0;left:-60%;width:40%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);
  animation:shimmer 2.8s ease-in-out infinite;pointer-events:none;
}
@keyframes shimmer{0%{left:-60%}75%,100%{left:120%}}
.inc-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;padding:0 12px;gap:10px;pointer-events:none;z-index:10;}
.inc-ol-adm{font-size:12px;font-weight:900;color:#fff;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.2);border-radius:6px;padding:3px 9px;white-space:nowrap;flex-shrink:0;}
.inc-ol-amt{font-size:14px;font-weight:900;color:#fff;white-space:nowrap;flex-shrink:0;text-shadow:0 1px 4px rgba(0,0,0,.9);}
.inc-stats{width:72px;flex-shrink:0;text-align:right;}
.inc-stat-amt{font-size:13px;font-weight:900;color:#10b981;display:block;line-height:1;}
.inc-stat-adm{font-size:10px;font-weight:700;color:rgba(255,255,255,.38);display:block;margin-top:2px;}
.inc-row:nth-child(1) .inc-bar{box-shadow:0 0 22px rgba(251,191,36,.28);}
.inc-row:nth-child(2) .inc-bar{box-shadow:0 0 16px rgba(148,163,184,.16);}
.inc-row:nth-child(3) .inc-bar{box-shadow:0 0 16px rgba(180,107,60,.2);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cal-overlay{
  position:fixed;inset:0;z-index:998;
  background:rgba(0,0,0,.45);
  opacity:0;pointer-events:none;
  transition:opacity .25s ease;
}
.cal-overlay.open{opacity:1;pointer-events:all;}
.cal-panel{
  position:fixed;top:0;right:0;bottom:0;width:340px;
  background:#111228;border-left:1px solid rgba(255,255,255,.09);
  z-index:999;transform:translateX(100%);
  transition:transform .3s cubic-bezier(.16,1,.3,1);
  display:flex;flex-direction:column;
  box-shadow:-20px 0 60px rgba(0,0,0,.6);
}
.cal-panel.open{transform:translateX(0);}
.cal-hdr{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.cal-hdr-title{font-size:15px;font-weight:800;display:flex;align-items:center;gap:8px;}
.cal-x{width:30px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.45);font-size:15px;transition:all .15s;}
.cal-x:hover{background:rgba(255,255,255,.12);color:#fff;}
.cal-body{flex:1;overflow-y:auto;padding:16px 20px;}
.cal-body::-webkit-scrollbar{width:3px;}
.cal-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px;}
.rd-wrap{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:13px 15px;margin-bottom:18px;}
.rd-lbl{font-size:9px;font-weight:800;color:rgba(255,255,255,.22);letter-spacing:.14em;text-transform:uppercase;margin-bottom:8px;}
.rd-dates{display:flex;align-items:center;gap:8px;}
.rd-box{flex:1;background:rgba(255,255,255,.06);border-radius:9px;padding:8px 10px;text-align:center;}
.rd-box-lbl{font-size:9px;color:rgba(255,255,255,.28);font-weight:700;display:block;margin-bottom:3px;}
.rd-box-val{font-size:13px;font-weight:800;display:block;}
.rd-sep{font-size:18px;color:rgba(255,255,255,.18);}
.sec-lbl{font-size:9px;font-weight:800;color:rgba(255,255,255,.22);letter-spacing:.14em;text-transform:uppercase;margin-bottom:9px;}
.presets{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:20px;}
.preset{padding:9px 8px;border-radius:9px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);cursor:pointer;font-size:12px;font-weight:700;color:rgba(255,255,255,.5);text-align:center;transition:all .15s;font-family:var(--font);}
.preset:hover{background:rgba(255,255,255,.09);color:#fff;}
.preset.sel{background:rgba(201,78,45,.15);border-color:rgba(201,78,45,.38);color:#f87c5e;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.cal-nav-btn{width:30px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.05);cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.45);font-size:18px;transition:all .15s;user-select:none;}
.cal-nav-btn:hover{background:rgba(255,255,255,.12);color:#fff;}
.cal-month{font-size:14px;font-weight:800;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;}
.cal-dow{font-size:10px;font-weight:700;color:rgba(255,255,255,.22);text-align:center;padding:5px 0;letter-spacing:.04em;}
.cal-day{
  aspect-ratio:1;border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;cursor:pointer;
  color:rgba(255,255,255,.6);
  transition:background .1s,color .1s;
  border:1px solid transparent;
  user-select:none;
}
.cal-day:hover:not(.empty){background:rgba(255,255,255,.1);color:#fff;}
.cal-day.empty{pointer-events:none;}
.cal-day.today{border-color:rgba(99,102,241,.5);color:#a5b4fc;background:rgba(99,102,241,.08);}
.cal-day.in-range{background:rgba(201,78,45,.13);color:rgba(255,255,255,.82);border-radius:0;}
.cal-day.range-start{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important;border-radius:7px 2px 2px 7px;}
.cal-day.range-end{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important;border-radius:2px 7px 7px 2px;}
.cal-day.range-start.range-end{border-radius:7px!important;}
.cal-footer{padding:14px 20px;border-top:1px solid rgba(255,255,255,.07);display:flex;flex-direction:column;gap:8px;flex-shrink:0;}
.btn-apply{padding:12px;border-radius:11px;background:var(--accent);border:none;color:#fff;font-size:13px;font-weight:800;cursor:pointer;font-family:var(--font);transition:all .15s ease;}
.btn-apply:hover:not(:disabled){background:#b8431f;transform:translateY(-1px);}
.btn-apply:disabled{opacity:.35;pointer-events:none;}
.btn-clear{padding:10px;border-radius:11px;background:transparent;border:1px solid rgba(255,255,255,.09);color:rgba(255,255,255,.38);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .15s ease;}
.btn-clear:hover{border-color:rgba(255,255,255,.2);color:rgba(255,255,255,.7);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ts-row{display:flex;align-items:center;justify-content:flex-end;gap:4px;margin-top:14px;font-size:10px;font-weight:600;color:rgba(255,255,255,.16);}
.ts-dot{width:4px;height:4px;border-radius:50%;background:#10b981;display:inline-block;animation:pulse 2s infinite;}
.nodata{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;gap:8px;}
.nodata .ico{font-size:28px;opacity:.2;}
.nodata p{font-size:11px;font-weight:600;color:rgba(255,255,255,.18);}

/* Counsellor filter tag */
.counsel-filter-tag{
  display:none;align-items:center;gap:7px;
  background:rgba(201,78,45,.12);border:1px solid rgba(201,78,45,.3);
  border-radius:20px;padding:4px 12px;
  font-size:11px;font-weight:700;color:#f87c5e;white-space:nowrap;
  animation:fadeUp .2s ease;
}
.counsel-filter-tag.show{display:flex;}
.counsel-filter-x{cursor:pointer;opacity:.55;font-size:14px;line-height:1;transition:opacity .15s;margin-left:2px;}
.counsel-filter-x:hover{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
.f1{animation:fadeUp .3s ease both;}
.f2{animation:fadeUp .3s ease both .06s;}
.f3{animation:fadeUp .3s ease both .12s;}
.f4{animation:fadeUp .3s ease both .18s;}

/* Skeleton shimmer for loading state */
.skel{
  background:linear-gradient(90deg,rgba(255,255,255,.04) 25%,rgba(255,255,255,.08) 50%,rgba(255,255,255,.04) 75%);
  background-size:200% 100%;
  animation:skelShimmer 1.5s infinite;
  border-radius:6px;
}
@keyframes skelShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Number counter animation */
@keyframes countUp{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.count-anim{animation:countUp .3s ease both;}

/* GPU promotion â€” only elements that animate transform */
.bf,.cg-fill,.bf-tgt,.inc-bar{will-change:transform;}
/* Layout containment â€” reduces style recalc scope */
.card,.full-card{contain:layout style;}
.wrap{contain:layout;}
.bt,.inc-track{isolation:isolate;}
</style>
</head>
<body>

<!-- LOADER -->
<div id="ldr">
  <div class="ldr-wrap">
    <div class="ldr-ring"></div>
    <div class="ldr-ico">ğŸ“</div>
  </div>
  <div class="ldr-txt">LOADING LIVE DATA</div>
</div>

<!-- CAL OVERLAY -->
<div class="cal-overlay" id="calOverlay"></div>

<!-- CALENDAR PANEL -->
<div class="cal-panel" id="calPanel">
  <div class="cal-hdr">
    <div class="cal-hdr-title">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Custom Date Range
    </div>
    <div class="cal-x" id="calClose">&#10005;</div>
  </div>
  <div class="cal-body">
    <div class="rd-wrap">
      <div class="rd-lbl">Selected Range</div>
      <div class="rd-dates">
        <div class="rd-box"><span class="rd-box-lbl">FROM</span><span class="rd-box-val" id="rdFrom">&#8212;</span></div>
        <div class="rd-sep">&#8594;</div>
        <div class="rd-box"><span class="rd-box-lbl">TO</span><span class="rd-box-val" id="rdTo">&#8212;</span></div>
      </div>
    </div>
    <div class="sec-lbl">Quick Presets</div>
    <div class="presets">
      <div class="preset" data-preset="today">Today</div>
      <div class="preset" data-preset="yesterday">Yesterday</div>
      <div class="preset" data-preset="last7">Last 7 Days</div>
      <div class="preset" data-preset="last30">Last 30 Days</div>
      <div class="preset" data-preset="thismonth">This Month</div>
      <div class="preset" data-preset="lastmonth">Last Month</div>
      <div class="preset" data-preset="thisyear">This Year</div>
      <div class="preset" data-preset="alltime">All Time</div>
    </div>
    <div class="sec-lbl">Pick Dates</div>
    <div class="cal-nav">
      <div class="cal-nav-btn" id="prevMo">&#8249;</div>
      <div class="cal-month" id="calMonthLbl"></div>
      <div class="cal-nav-btn" id="nextMo">&#8250;</div>
    </div>
    <div class="cal-grid" id="calDow"></div>
    <div class="cal-grid" id="calDays"></div>
  </div>
  <div class="cal-footer">
    <button class="btn-apply" id="btnApply" disabled>Apply Range</button>
    <button class="btn-clear" id="btnClear">Clear</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="wrap" id="dash" style="display:none">

  <!-- TOPBAR -->
  <div class="topbar f1">
    <div class="brand">
      <div class="brand-ico">ğŸ“</div>
      <div>
        <div class="brand-title">Admissions Dashboard</div>
        <div class="brand-sub">HIGHER.STUDY &middot; REAL-TIME 2026</div>
      </div>
    </div>
    <div class="top-r">
      <div class="tabs">
        <button class="tab on" data-p="all">All Time</button>
        <button class="tab" data-p="today">Today</button>
        <button class="tab" data-p="thisweek">This Week</button>
        <button class="tab" data-p="lastweek">Last Week</button>
        <button class="tab" data-p="monthly">Month</button>
      </div>
      <button class="cal-btn" id="calBtn">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        Custom Range
      </button>
      <div class="ava">V</div>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="statusbar f1">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div class="live-wrap"><div class="live-dot"></div><span class="live-txt" id="stxt">Connectingâ€¦</span></div>
      <div class="range-badge" id="rangeBadge">
        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        <span id="rangeBadgeTxt"></span>
        <span class="rbx" id="rangeBadgeX">&#10005;</span>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi net"><span class="kpi-lbl">NET ADM</span><span class="kpi-val" id="pnet">&#8212;</span></div>
      <div class="kpi tot"><span class="kpi-lbl">TOTAL</span><span class="kpi-val" id="ptot">&#8212;</span></div>
      <div class="kpi can"><span class="kpi-lbl">CANCEL</span><span class="kpi-val" id="pcan">&#8212;</span></div>
    </div>
  </div>

  <!-- ROW 1: Manager + University -->
  <div class="g2 f2">
    <div class="card">
      <div class="card-head"><span class="card-title">Manager Performance</span><span class="card-badge" id="mb-b">&#8212;</span></div>
      <div class="barlist" id="mb"></div>
      <div class="ts-row"><span class="ts-dot"></span>&nbsp;<span id="t1" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.16)">&#8212;</span></div>
    </div>
    <div class="card univ-card">
      <div class="card-head"><span class="card-title">University Split</span><span class="card-badge" id="ub-b">&#8212;</span></div>
      <div class="donut-wrap">
        <div class="donut-box">
          <svg width="148" height="148" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="38" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="12"/>
            <circle id="u1" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
            <circle id="u2" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
            <circle id="u3" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
            <circle id="u4" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
            <circle id="u5" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
            <circle id="u6" cx="50" cy="50" r="38" fill="none" stroke-width="12" stroke-dasharray="0 238.8" transform="rotate(-90 50 50)"/>
          </svg>
          <div class="donut-ctr"><div class="donut-num" id="unum">&#8212;</div><span class="donut-sub" id="uSub">NET ADM</span></div>
        </div>
        <div class="leg" id="uleg"></div>
      </div>
      <div class="univ-filter-tag" id="univFilterTag">
        Showing: <span class="univ-filter-name" id="univFilterName"></span>
        <span class="univ-filter-x" id="univFilterX">&#10005;</span>
      </div>
      <div class="ts-row"><span class="ts-dot"></span>&nbsp;<span id="t2" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.16)">&#8212;</span></div>
    </div>
  </div>

  <!-- ROW 2: TL + Top Performers -->
  <div class="g2 f3">
    <div class="card">
      <div class="card-head"><span class="card-title">Team Leader Performance</span><span class="card-badge" id="tb-b">&#8212;</span></div>
      <div class="barlist" id="tb"></div>
      <div class="ts-row"><span class="ts-dot"></span>&nbsp;<span id="t3" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.16)">&#8212;</span></div>
    </div>
    <div class="card">
      <div class="card-head"><span class="card-title">Top Performers</span><span class="card-badge">RANKINGS</span></div>
      <div class="tlist" id="tlist"></div>
    </div>
  </div>

  <!-- TREND CHART -->
  <div class="full-card f4">
    <div class="trend-head">
      <div class="card-title">ğŸ“ˆ Admission Trend Analysis</div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div class="trend-filters">
          <div class="tf on" data-tf="daily">Daily</div>
          <div class="tf" data-tf="weekly">Weekly</div>
          <div class="tf" data-tf="monthly">Monthly</div>
        </div>
        <div class="ts-row" style="margin:0"><span class="ts-dot"></span>&nbsp;<span id="t4" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.16)">&#8212;</span></div>
      </div>
    </div>
    <div class="trend-stats" id="trendStats"></div>
    <div class="chart-wrap" id="chartWrap">
      <svg class="chart-svg" id="chartSvg"></svg>
      <div class="chart-tip" id="chartTip">
        <div class="tt-date" id="ttDate"></div>
        <span style="color:#818cf8;margin-right:4px;">â—</span><span class="tt-val" id="ttVal"></span>
      </div>
    </div>
  </div>

  <!-- COUNSELLOR -->
  <div class="full-card f4">
    <div class="counsel-head">
      <div class="counsel-head-left">
        <div class="card-title">ğŸ§‘â€ğŸ’¼ Counsellor Performance</div>
        <span class="card-badge" id="cBadge">&#8212;</span>
        <div class="counsel-filter-tag" id="counselFilterTag">
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 3H2l8 9.46V19l4 2V12.46z"/></svg>
          <span id="counselFilterName"></span>
          <span class="counsel-filter-x" id="counselFilterX">&#10005;</span>
        </div>
      </div>
      <div class="counsel-search">
        <svg width="12" height="12" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="cSearch" placeholder="Search counsellorâ€¦" autocomplete="off">
      </div>
    </div>
    <div class="c-podium-wrap" id="cPodium"></div>
    <div class="c-grid" id="cGrid"></div>
    <div class="inc-section" id="incSection" style="display:none;">
      <div class="inc-head">
        <div>
          <div class="inc-head-title">ğŸ’° Incentive Leaderboard</div>
          <div class="inc-head-sub">Sorted by earnings</div>
        </div>
        <div class="inc-total-pill" id="incTotal"></div>
      </div>
      <div class="inc-chart" id="incChart"></div>
    </div>
    <div class="ts-row" style="margin-top:12px;"><span class="ts-dot"></span>&nbsp;<span id="t5" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.16)">&#8212;</span></div>
  </div>

</div><!-- /wrap -->

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'https://script.google.com/macros/s/AKfycbzDv1IF3DtUDucu57R4aCAhRbUUqpwKSqhaOEaZ4CWl9kqoub3v0NR00SkZHj-PXfUx/exec';
const CACHE_KEY  = 'hsd18_';   // bump to bust all cache
const MEM_TTL    = 5 * 60 * 1000;
const DISK_TTL   = 5 * 60 * 1000;
const RETRY_MS   = 20 * 1000;
const DONUT_C    = 238.8;

const MGRS = Object.freeze([
  {n:'Deepesh',  k:'deepesh',  c:'c1'},
  {n:'Aslam',    k:'aslam',    c:'c2'},
  {n:'Aasif',    k:'aasif',    c:'c3'},
  {n:'Manas',    k:'manas',    c:'c4'},
]);
const TLS = Object.freeze([
  {n:'Akshay',    k:'tlAkshay',    c:'c1'},
  {n:'Kajal',     k:'tlKajal',     c:'c5'},
  {n:'Devashis',  k:'tlDevashis',  c:'c2'},
  {n:'Antaryami', k:'tlAntaryami', c:'c3'},
  {n:'Manas',     k:'tlManas',     c:'c4'},
  {n:'Priyanka',  k:'tlPriyanka',  c:'c1'},
  {n:'Ruthvik',   k:'tlRuthvik',   c:'c2'},
  {n:'Bhakti',    k:'tlBhakti',    c:'c3'},
]);
const UNIVS = Object.freeze([
  {n:'Alliance',   k:'alliance',   cl:'#22d3ee'},
  {n:'Amity',      k:'amity',      cl:'#818cf8'},
  {n:'Chandigarh', k:'chandigarh', cl:'#34d399'},
  {n:'Presidency', k:'presidency', cl:'#fbbf24'},
  {n:'CV Raman',   k:'cvRaman',    cl:'#f472b6'},
  {n:'Others',     k:'others',     cl:'#475569'},
]);
const MONTHS   = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MO_ABBR  = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
const MO_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DOWS     = ['Su','Mo','Tu','We','Th','Fr','Sa'];
const DOT_CLR  = ['#818cf8','#22d3ee','#c084fc','#34d399','#f472b6','#f59e0b','#60a5fa','#a78bfa','#6ee7b7','#fca5a5','#fb923c','#4ade80','#e879f9','#38bdf8','#fde047','#f87171','#a3e635','#2dd4bf','#d946ef','#93c5fd'];
const INC_GRD  = ['linear-gradient(90deg,#7c2d12,#c2410c,#fb923c)','linear-gradient(90deg,#1e293b,#334155,#94a3b8)','linear-gradient(90deg,#451a03,#92400e,#d97706)','linear-gradient(90deg,#1e1b4b,#3730a3,#818cf8)','linear-gradient(90deg,#083344,#0e7490,#22d3ee)','linear-gradient(90deg,#2e1065,#6d28d9,#a78bfa)','linear-gradient(90deg,#052e16,#166534,#4ade80)','linear-gradient(90deg,#500724,#9f1239,#fb7185)','linear-gradient(90deg,#0c4a6e,#0369a1,#38bdf8)','linear-gradient(90deg,#4a044e,#86198f,#e879f9)'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const mem = Object.create(null);   // ck â†’ {data, ts}
let activeCk     = 'all';
let activePeriod = 'all';          // human-readable period string
let customFrom   = null;
let customTo     = null;
let allCounselData = [];
let cSearchVal   = '';
let trendFilter  = 'daily';
let activeMgr    = null;
let activeTL     = null;
let lastTrendRows = [];
let refreshTimer  = null;
let searchTimer   = null;
let shown         = false;
let renderToken   = 0;             // race-condition guard

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _elCache = Object.create(null);
const $  = id => _elCache[id] || (_elCache[id] = document.getElementById(id));
const $f = id => document.getElementById(id);   // fresh â€” for dynamic elements
const $q = sel => document.querySelector(sel);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtInc(n){
  if(n>=100000) return (n/100000).toFixed(1)+'L';
  if(n>=1000)   return (n/1000).toFixed(1)+'K';
  return Math.round(n).toLocaleString('en-IN');
}
function nd(msg){ return`<div class="nodata"><div class="ico">ğŸ“­</div><p>${msg}</p></div>`; }
function setSt(t){ const e=$('stxt'); if(e) e.innerHTML=t; }

const _rgbaCache = Object.create(null);
function rgba(hex,a){
  const k=hex+a;
  if(_rgbaCache[k]) return _rgbaCache[k];
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return (_rgbaCache[k]=`rgba(${r},${g},${b},${a})`);
}

function trRow(ico,role,name,count,cls){
  return `<div class="ti ${cls}"><span class="t-ico">${ico}</span><div class="t-body"><span class="t-role">${role}</span><span class="t-name">${name}</span></div><div class="t-right"><span class="t-num">${count}</span><span class="t-lbl">Admissions</span></div></div>`;
}

function showDash(){
  if(shown) return;
  shown=true;
  const l=$('ldr');
  l.classList.add('out');
  setTimeout(()=>{ l.style.display='none'; }, 400);
  $('dash').style.display='block';
}

// Animate number â€” rAF + easeOutExpo, no setInterval, cancellable
const _animRaf = new WeakMap();
function animCount(el, target){
  if(!el) return;
  const start = parseInt(el.textContent)||0;
  if(start===target){ el.textContent=target; return; }
  const prev = _animRaf.get(el); if(prev) cancelAnimationFrame(prev);
  const dur=380, t0=performance.now();
  function tick(now){
    const pct=Math.min(1,(now-t0)/dur);
    const ease=pct===1?1:1-Math.pow(2,-10*pct);
    el.textContent=Math.round(start+(target-start)*ease);
    if(pct<1) _animRaf.set(el,requestAnimationFrame(tick));
    else{ el.textContent=target; _animRaf.delete(el); }
  }
  _animRaf.set(el,requestAnimationFrame(tick));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISK CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dkRead(k){
  try{
    const s=localStorage.getItem(CACHE_KEY+k);
    if(!s) return null;
    const o=JSON.parse(s);
    if(Date.now()-o.ts > DISK_TTL){ localStorage.removeItem(CACHE_KEY+k); return null; }
    return o;
  }catch{ return null; }
}
// Defer disk writes to idle â€” never blocks the main thread
const _dkQ=Object.create(null); let _dkTimer=null;
function dkWrite(k,data){
  _dkQ[k]=data;
  if(_dkTimer) return;
  const flush=()=>{
    _dkTimer=null;
    for(const key of Object.keys(_dkQ)){
      try{ localStorage.setItem(CACHE_KEY+key,JSON.stringify({data:_dkQ[key],ts:Date.now()})); }
      catch{
        // Storage full â€” evict oldest hsd key and retry
        try{
          const all=Object.keys(localStorage).filter(x=>x.startsWith(CACHE_KEY));
          if(all.length) localStorage.removeItem(all[0]);
          localStorage.setItem(CACHE_KEY+key,JSON.stringify({data:_dkQ[key],ts:Date.now()}));
        }catch{}
      }
      delete _dkQ[key];
    }
  };
  _dkTimer = typeof requestIdleCallback!=='undefined'
    ? requestIdleCallback(flush,{timeout:2000})
    : setTimeout(flush,100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseLocalDate(s){
  if(!s) return null;
  s=String(s).trim();
  let m=s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
  if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  m=s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
  if(m) return new Date(+m[3],+m[2]-1,+m[1]);
  const d=new Date(s.replace(/-/g,'/')); return isNaN(d)?null:d;
}
function monWeekStart(dt){
  // Returns Monday 00:00:00.000 of the week containing dt
  const d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 0, 0, 0, 0);
  const dow = d.getDay(); // 0=Sun, 1=Mon ... 6=Sat
  const diff = dow===0 ? -6 : 1-dow;  // days to subtract to get to Monday
  d.setDate(d.getDate() + diff);
  return d;
}
function sunWeekEnd(dt){
  // Returns Sunday 23:59:59.999 of the week containing dt
  const mon = monWeekStart(dt);
  return new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()+6, 23, 59, 59, 999);
}
function iso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function fmtDisp(d){ return d?`${d.getDate()} ${MONTHS[d.getMonth()].slice(0,3)} ${d.getFullYear()}`:'â€”'; }
function dayTs(d){ return d?new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime():0; }
const TODAY_TS = dayTs(new Date());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEK RANGE HELPERS
// Returns {mon, sun} for the correct Monâ€“Sun window
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWeekRange(p){
  const today = new Date();
  if(p==='weekly'||p==='thisweek'){
    const mon = monWeekStart(today);                                          // Mon 00:00:00
    const sun = new Date(mon.getFullYear(),mon.getMonth(),mon.getDate()+6,23,59,59,999); // Sun 23:59:59
    return {mon, sun};
  }
  if(p==='lastweek'){
    const thisMon = monWeekStart(today);
    const mon = new Date(thisMon.getFullYear(),thisMon.getMonth(),thisMon.getDate()-7,0,0,0,0);
    const sun = new Date(mon.getFullYear(),mon.getMonth(),mon.getDate()+6,23,59,59,999);
    return {mon, sun};
  }
  return null;
}

function inRange(dateStr, mon, sun){
  const dt = parseLocalDate(dateStr);
  if(!dt) return false;
  // Use noon to avoid any DST edge cases
  const d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 12, 0, 0);
  return d >= mon && d <= sun;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NORMALISE â€” called exactly once per fetch
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function norm(raw, p){
  if(!raw || raw.error) return null;
  if(!Array.isArray(raw.trendRows)) raw.trendRows = [];

  // Preserve target fields
  const mgrTargets    = raw.mgrTargets    || {};
  const mgrTargetsAll = raw.mgrTargetsAll || {};

  // â”€â”€ Always keep the FULL unfiltered trendRows for counsellor/incentive â”€â”€
  // counsellors show for the FULL period (all, month, week - whatever server sent)
  raw.allTrendRows = raw.trendRows.slice();

  if(!raw.trendRows.length){
    raw.others        = Math.max(0, raw.netAdm||0);
    raw.mgrTargets    = mgrTargets;
    raw.mgrTargetsAll = mgrTargetsAll;
    return raw;
  }

  // â”€â”€ Week filter: narrow trendRows to the correct Monâ€“Sun window â”€â”€
  const weekRange = getWeekRange(p);
  const filteredRows = weekRange
    ? raw.trendRows.filter(r => inRange(r.date, weekRange.mon, weekRange.sun))
    : raw.trendRows;

  // â”€â”€ Replace trendRows with filtered set (used by trend chart + bar counts) â”€â”€
  raw.trendRows = filteredRows;

  // â”€â”€ Recount from filtered rows â”€â”€
  const mgr  = {deepesh:0, aslam:0, aasif:0, manas:0};
  const tl   = {tlAkshay:0, tlKajal:0, tlDevashis:0, tlAntaryami:0, tlManas:0, tlPriyanka:0, tlRuthvik:0, tlBhakti:0};
  const univ = {alliance:0, amity:0, chandigarh:0, presidency:0, cvRaman:0, gift:0, centurion:0, driems:0};
  let count = 0;

  for(let i=0, L=filteredRows.length; i<L; i++){
    const r = filteredRows[i];
    switch((r.mgr||'').trim().toLowerCase()){
      case 'deepesh': mgr.deepesh++; break;
      case 'aslam':   mgr.aslam++;   break;
      case 'aasif':   mgr.aasif++;   break;
      case 'manas':   mgr.manas++;   break;
    }
    const tR = (r.tl||'').trim().toLowerCase();
    const tlKey=resolveTL(tR); if(tlKey) tl[tlKey]=(tl[tlKey]||0)+1;
    const uR = (r.univ||'').trim().toLowerCase();
    if     (uR.includes('alliance'))               univ.alliance++;
    else if(uR.includes('amity'))                  univ.amity++;
    else if(uR.includes('chandigarh'))             univ.chandigarh++;
    else if(uR.includes('presidency'))             univ.presidency++;
    else if(uR.includes('raman'))                  univ.cvRaman++;
    else if(uR.includes('gift'))                   univ.gift++;
    else if(uR.includes('centurion'))              univ.centurion++;
    else if(uR.includes('driems'))                 univ.driems++;
    count++;
  }

  Object.assign(raw, mgr, tl, univ);
  if(count > 0) raw.netAdm = count;
  const kn = (raw.alliance||0)+(raw.amity||0)+(raw.chandigarh||0)+(raw.presidency||0)
           + (raw.cvRaman||0)+(raw.gift||0)+(raw.centurion||0)+(raw.driems||0);
  raw.others        = Math.max(0, (raw.netAdm||0) - kn);
  raw.mgrTargets    = mgrTargets;
  raw.mgrTargetsAll = mgrTargetsAll;
  return raw;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchOne(p, from, to){
  let url=API+'?sheet='+encodeURIComponent(p);
  if(from&&to) url+=`&from=${from}&to=${to}`;
  const r=await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const raw=await r.json();
  return norm(raw,p);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD â€” race-safe, instant-from-cache
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function load(p, from=null, to=null, force=false){
  clearTimeout(refreshTimer);
  const ck       = from?`cr_${from}_${to}`:p;
  const isCustom = !!from;
  const token    = ++renderToken;

  function safeRender(data, stale){
    if(token!==renderToken) return;  // stale â€” newer request in flight
    activeCk     = ck;
    activePeriod = p;
    render(data, stale, p);
  }

  // 1. Memory hit â€” instant
  if(!force && mem[ck] && (Date.now()-mem[ck].ts)<MEM_TTL){
    safeRender(mem[ck].data, true);
    if(!isCustom) schedRefresh(ck,p,from,to,token);
    return;
  }

  // 2. Disk hit â€” render immediately, refresh silently
  const dk=dkRead(ck);
  if(dk){
    mem[ck]={data:dk.data,ts:dk.ts};
    safeRender(dk.data, true);
    showDash();
    fetchOne(p,from,to).then(d=>{
      if(!d||token!==renderToken) return;
      mem[ck]={data:d,ts:Date.now()}; dkWrite(ck,d);
      safeRender(d,false);
      if(!isCustom) schedRefresh(ck,p,from,to,token);
    }).catch(()=>{});
    return;
  }

  // 3. Cold fetch
  setSt('âš¡ Fetchingâ€¦');
  try{
    const d=await fetchOne(p,from,to);
    if(token!==renderToken) return;
    if(!d){ setSt('âš  No data'); showDash(); return; }
    mem[ck]={data:d,ts:Date.now()}; dkWrite(ck,d);
    safeRender(d,false);
    if(!isCustom) schedRefresh(ck,p,from,to,token);
  }catch(e){
    if(token!==renderToken) return;
    setSt('âš  Failed Â· retry 20s');
    refreshTimer=setTimeout(()=>load(p,from,to,true),RETRY_MS);
    showDash();
  }
}

function schedRefresh(ck,p,from,to,token){
  clearTimeout(refreshTimer);
  refreshTimer=setTimeout(()=>{
    if(renderToken!==token) return;
    fetchOne(p,from,to).then(d=>{
      if(!d||renderToken!==token) return;
      mem[ck]={data:d,ts:Date.now()}; dkWrite(ck,d);
      render(d,false,p);
      schedRefresh(ck,p,from,to,token);
    }).catch(()=>{ if(renderToken===token) schedRefresh(ck,p,from,to,token); });
  }, MEM_TTL);
}

function prefetchAll(){
  // Standard tabs
  ['all','today','monthly'].forEach(p=>{
    if(mem[p]) return;
    const dk=dkRead(p);
    if(dk){ mem[p]={data:dk.data,ts:dk.ts}; return; }
    fetchOne(p,null,null).then(d=>{
      if(!d) return;
      mem[p]={data:d,ts:Date.now()}; dkWrite(p,d);
      if(activeCk===p) render(d,false,p);
    }).catch(()=>{});
  });
  // This week â€” always pass explicit Monâ€“Sun dates
  {
    const n=new Date(); n.setHours(0,0,0,0);
    const wMon=monWeekStart(n), wSun=sunWeekEnd(n);
    const wf=iso(wMon), wt=iso(wSun), wCk=`cr_${wf}_${wt}`;
    if(!mem[wCk]){
      const dk=dkRead(wCk);
      if(dk){ mem[wCk]={data:dk.data,ts:dk.ts}; }
      else {
        fetchOne('weekly',wf,wt).then(d=>{
          if(!d) return;
          mem[wCk]={data:d,ts:Date.now()}; dkWrite(wCk,d);
          if(activeCk===wCk) render(d,false,'weekly');
        }).catch(()=>{});
      }
    }
  }
  // Last week
  const n=new Date(); n.setHours(0,0,0,0);
  const thisMon=monWeekStart(n);
  const lMon=new Date(thisMon); lMon.setDate(lMon.getDate()-7);
  const lSun=new Date(lMon);    lSun.setDate(lSun.getDate()+6);
  const lf=iso(lMon), lt=iso(lSun), lwCk=`cr_${lf}_${lt}`;
  if(!mem[lwCk]){
    const dk=dkRead(lwCk);
    if(dk){ mem[lwCk]={data:dk.data,ts:dk.ts}; return; }
    fetchOne('lastweek',lf,lt).then(d=>{
      if(!d) return;
      mem[lwCk]={data:d,ts:Date.now()}; dkWrite(lwCk,d);
      if(activeCk===lwCk) render(d,false,'lastweek');
    }).catch(()=>{});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESOLVE TARGETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resolveTargets(d, p){
  const all = d.mgrTargetsAll || {};
  const curMo = MO_ABBR[new Date().getMonth()];

  // Find best available monthly targets
  let monthly = {};
  // Priority: current month â†’ flat mgrTargets â†’ any available month
  if(all[curMo] && Object.keys(all[curMo]).length){
    monthly = all[curMo];
  } else if(d.mgrTargets && Object.keys(d.mgrTargets).length){
    monthly = d.mgrTargets;
  } else {
    const found = Object.values(all).find(m=>Object.keys(m).length>0);
    if(found) monthly = found;
  }

  const isMonthTab  = p==='monthly';
  const isWeekTab   = p==='weekly'||p==='thisweek'||p==='lastweek';
  const hasTargets  = Object.keys(monthly).length>0;
  const showTargets = (isMonthTab||isWeekTab) && hasTargets;

  // Build resolved targets (weekly = monthly/4)
  const targets = Object.create(null);
  if(showTargets){
    Object.entries(monthly).forEach(([k,v])=>{
      targets[k.toLowerCase()] = isWeekTab ? Math.round(v/4) : v;
    });
  }

  // Lookup helper â€” case insensitive
  function get(mgr){
    return targets[mgr.k]||targets[mgr.k.toLowerCase()]||targets[mgr.n.toLowerCase()]||0;
  }

  return {showTargets, targets, get, isWeekTab};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(d, stale, p){
  const net=d.netAdm||0, tot=d.totalAdm||0, can=d.cancelAdm||0;

  // KPIs â€” animate numbers
  animCount($('pnet'), net);
  animCount($('ptot'), tot);
  animCount($('pcan'), can);
  $('mb-b').textContent = net+' ADM';
  $('tb-b').textContent = net+' ADM';

  lastTrendRows = d.trendRows||[];

  // â”€â”€ Target resolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const {showTargets, get: tgtGet, isWeekTab} = resolveTargets(d, p);

  // â”€â”€ Manager bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sortedMgrs = [...MGRS].sort((a,b)=>(d[b.k]||0)-(d[a.k]||0));
  const maxMgr = Math.max(1, ...MGRS.map(m=>Math.max(d[m.k]||0, showTargets?tgtGet(m):0)));
  // Clear dynamic el cache
  MGRS.forEach((_,i)=>{ delete _elCache['mb'+i]; delete _elCache['mbt'+i]; });

  if(net===0){
    $('mb').innerHTML = nd('No admissions for this period');
  } else {
    const frag = document.createDocumentFragment();
    sortedMgrs.forEach((m,i)=>{
      const v   = d[m.k]||0;
      const tgt = showTargets ? tgtGet(m) : 0;
      const pct = tgt>0 ? Math.min(100,Math.round((v/tgt)*100)) : null;

      const wrap = document.createElement('div');
      wrap.className='br-wrap';

      const row = document.createElement('div');
      row.className='br'; row.id='mbr'+i;
      row.dataset.mgr=m.k; row.dataset.mgrn=m.n;
      row.innerHTML=`<div class="bn">${m.n}</div><div class="bt"><div class="bt-bg"></div><div class="bf ${m.c}" id="mb${i}"></div><span class="bl">${v} adm</span></div><div class="bv">${v}</div>`;
      row.addEventListener('click',()=>toggleMgrFilter(m.k,m.n),{passive:true});
      wrap.appendChild(row);

      if(showTargets && tgt>0){
        const tgtRow=document.createElement('div');
        tgtRow.className='br-target show';
        const lbl=isWeekTab?'WK TARGET':'TARGET';
        tgtRow.innerHTML=`<div class="bn-tgt">${lbl}</div><div class="bt-tgt"><div class="bf-tgt" id="mbt${i}"></div><span class="bt-tgt-lbl">${v}/${tgt}${pct!==null?' Â· '+pct+'%':''}</span></div><div class="bv-tgt">${tgt}</div>`;
        wrap.appendChild(tgtRow);
      }
      frag.appendChild(wrap);
    });
    $('mb').innerHTML='';
    $('mb').appendChild(frag);
  }

  // â”€â”€ TL bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sortedTLs = [...TLS].sort((a,b)=>(d[b.k]||0)-(d[a.k]||0));
  const maxTL = Math.max(1,...TLS.map(t=>d[t.k]||0));
  TLS.forEach((_,i)=>{ delete _elCache['tb'+i]; });

  if(net===0){
    $('tb').innerHTML=nd('No admissions for this period');
  } else {
    const frag=document.createDocumentFragment();
    sortedTLs.forEach((t,i)=>{
      const v=d[t.k]||0;
      const row=document.createElement('div');
      row.className='br'; row.id='tbr'+i;
      row.dataset.tl=t.k; row.dataset.tln=t.n;
      row.innerHTML=`<div class="bn">${t.n}</div><div class="bt"><div class="bt-bg"></div><div class="bf ${t.c}" id="tb${i}"></div><span class="bl">${v} adm</span></div><div class="bv">${v}</div>`;
      row.addEventListener('click',()=>toggleTLFilter(t.k,t.n),{passive:true});
      frag.appendChild(row);
    });
    $('tb').innerHTML='';
    $('tb').appendChild(frag);
  }

  // â”€â”€ Top performers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const topM=[...MGRS].sort((a,b)=>(d[b.k]||0)-(d[a.k]||0));
  const topT=[...TLS].sort((a,b)=>(d[b.k]||0)-(d[a.k]||0));
  $('tlist').innerHTML = net===0 ? nd('No data') : [
    trRow('ğŸ†','Manager',     topM[0].n, d[topM[0].k]||0, 'r1'),
    trRow('ğŸ¥‡','Team Leader', topT[0].n, d[topT[0].k]||0, 'r2'),
    topT[1]?trRow('ğŸ¥ˆ','Team Leader',topT[1].n,d[topT[1].k]||0,'r3'):'',
  ].join('');

  // â”€â”€ Reset donut + counsellor filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  activeMgr=null; activeTL=null;
  syncBarStates();
  $('univFilterTag').classList.remove('show');
  updateDonut(d, lastTrendRows);
  // Reset counsellor filter tag too
  const cfTag=$('counselFilterTag');
  if(cfTag) cfTag.classList.remove('show');

  // â”€â”€ Timestamps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ts=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  const staleTxt = stale ? 'âš¡ Cached Â· ' : 'âœ“ Live Â· ';
  ['t1','t2','t3'].forEach(id=>{ const e=$(id); if(e) e.textContent=staleTxt+ts; });
  setSt(stale ? 'âš¡ Instant Â· refreshing in background' : 'âœ… Live data Â· refreshes in 5 min');

  // â”€â”€ Bar animations â€” batch READ then WRITE to avoid layout thrash â”€â”€
  requestAnimationFrame(()=>{
    // READ: collect all els in one pass (no style reads = no forced layout)
    const mEls=sortedMgrs.map((_,i)=>$f('mb'+i));
    const tEls=sortedTLs.map((_,i)=>$f('tb'+i));
    const mtEls=showTargets?sortedMgrs.map((_,i)=>$f('mbt'+i)):[];
    // WRITE 1: reset transforms (no transition)
    for(let i=0;i<mEls.length;i++){const e=mEls[i];if(e){e.style.transition='none';e.style.transform='scaleX(0)';}}
    for(let i=0;i<tEls.length;i++){const e=tEls[i];if(e){e.style.transition='none';e.style.transform='scaleX(0)';}}
    for(let i=0;i<mtEls.length;i++){const e=mtEls[i];if(e){e.style.transition='none';e.style.transform='scaleX(0)';}}
    // WRITE 2: animate to final values
    requestAnimationFrame(()=>{
      for(let i=0;i<mEls.length;i++){const e=mEls[i];if(e){e.style.transition='';e.style.transform=`scaleX(${(d[sortedMgrs[i].k]||0)/maxMgr})`;}}
      for(let i=0;i<tEls.length;i++){const e=tEls[i];if(e){e.style.transition='';e.style.transform=`scaleX(${(d[sortedTLs[i].k]||0)/maxTL})`;}}
      if(showTargets){
        for(let i=0;i<mtEls.length;i++){
          const e=mtEls[i]; if(!e) continue;
          const tgt=tgtGet(sortedMgrs[i]);
          if(tgt>0){e.style.transition='';e.style.transform=`scaleX(${tgt/maxMgr})`;}
        }
      }
    });
  });

  // â”€â”€ Trend + Counsellor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Trend uses allTrendRows (full period) â€” groups by Daily/Weekly/Monthly
  // Donut uses lastTrendRows (week-filtered when on week tabs)
  // Counsellor uses allTrendRows (full period)
  drawTrend(d.allTrendRows || d.trendRows || []);
  drawCounsel(d.allTrendRows || d.trendRows || []);
  showDash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// O(1) lookups pre-built at module load
const _mgrByKey=Object.create(null); MGRS.forEach(m=>_mgrByKey[m.k]=m);
const _tlByKey =Object.create(null); TLS.forEach(t=>_tlByKey[t.k]=t);
const _univLC  =UNIVS.map(u=>u.n.toLowerCase()); // pre-lowercased

// TL name alias map â€” handles spelling variations from the sheet
// key = lowercase sheet value â†’ canonical TL key
const _tlAlias = {
  'akshay':'tlAkshay',
  'kajal':'tlKajal',
  'devashis':'tlDevashis','devashish':'tlDevashis',
  'antaryami':'tlAntaryami',
  'manas':'tlManas',
  'priyanka':'tlPriyanka',
  'ruthvik':'tlRuthvik','hruthvik':'tlRuthvik','rutvik':'tlRuthvik',
  'rutwik':'tlRuthvik','hruthik':'tlRuthvik','ruthwik':'tlRuthvik',
  'rithvik':'tlRuthvik','hrithvik':'tlRuthvik',
  'bhakti':'tlBhakti',
};
function resolveTL(raw){ return _tlAlias[raw]||null; }

// Also build reverse map: tlKey â†’ canonical lowercase name for filter matching
const _tlKeyToLC = Object.create(null);
TLS.forEach(t=>_tlKeyToLC[t.k]=t.n.toLowerCase());

function updateDonut(d,rows){
  const UL=UNIVS.length;
  const uvArr=new Int32Array(UL); // typed â€” fastest accumulator
  const fk=activeMgr||activeTL;
  const ft=activeMgr?'mgr':'tl';

  if(fk&&rows.length){
    const fObj=activeMgr?_mgrByKey[fk]:_tlByKey[fk];
    const fname=fObj?fObj.n.toLowerCase():'';
    for(let i=0,L=rows.length;i<L;i++){
      const r=rows[i];
      // For TL filter: match via alias map so spelling variants from sheet are caught
      if(ft==='tl'){
        const rTL=(r.tl||'').trim().toLowerCase();
        const resolved=resolveTL(rTL);
        if(resolved!==fk) continue;
      } else {
        if((r[ft]||'').trim().toLowerCase()!==fname) continue;
      }
      const u=(r.univ||'').trim().toLowerCase(); if(!u) continue;
      let hit=false;
      for(let j=0;j<UL-1;j++){if(u.includes(_univLC[j])){uvArr[j]++;hit=true;break;}}
      if(!hit) uvArr[UL-1]++;
    }
    let sum=0; for(let j=0;j<UL;j++) sum+=uvArr[j];
    if(sum===0){
      const ratio=(d[fk]||0)/Math.max(d.netAdm||1,1);
      for(let j=0;j<UL;j++) uvArr[j]=Math.round((d[UNIVS[j].k]||0)*ratio);
    }
  }else{
    for(let j=0;j<UL;j++) uvArr[j]=d[UNIVS[j].k]||0;
  }

  let total=0; for(let j=0;j<UL;j++) total+=uvArr[j];
  animCount($('unum'),total);

  const fObj=activeMgr?_mgrByKey[activeMgr]:activeTL?_tlByKey[activeTL]:null;
  const fName=fObj?fObj.n:'';
  let nUnivs=0; for(let j=0;j<UL;j++) if(uvArr[j]>0) nUnivs++;
  $('ub-b').textContent=(fName?fName+' Â· ':'')+nUnivs+' UNIVS';
  $('uSub').textContent=fName?fName+' ADM':'NET ADM';

  // Single pass: update donut segments + build legend
  let off=0; const legParts=[];
  for(let j=0;j<UL;j++){
    const u=UNIVS[j],v=uvArr[j];
    const arc=total>0?(v/total)*DONUT_C:0;
    const s=$('u'+(j+1));
    if(s){s.setAttribute('stroke',u.cl);s.setAttribute('stroke-dasharray',arc+' '+DONUT_C);s.setAttribute('stroke-dashoffset',-off);}
    off+=arc;
    legParts.push(`<div class="leg-row"><div class="leg-l"><div class="leg-dot" style="background:${u.cl}"></div><span class="leg-name">${u.n}</span></div><span class="leg-pct">${total>0?Math.round(v/total*100):0}%</span><span class="leg-val">${v}</span></div>`);
  }
  $('uleg').innerHTML=legParts.join('');
}

function toggleMgrFilter(key,name){
  const cached=mem[activeCk]; if(!cached)return;
  activeTL=null;
  const wasActive = activeMgr===key;
  activeMgr = wasActive ? null : key;

  // Donut filter tag
  if(activeMgr){ $('univFilterName').textContent=name; $('univFilterTag').classList.add('show'); }
  else { $('univFilterTag').classList.remove('show'); }

  syncBarStates();
  updateDonut(cached.data, lastTrendRows);

  // Filter counsellor section to show only this manager's counsellors
  const d = cached.data;
  const allRows = d.allTrendRows || d.trendRows || [];
  if(activeMgr){
    const mgrRows = allRows.filter(r=>(r.mgr||'').trim().toLowerCase()===name.toLowerCase());
    filterCounselSection(mgrRows, name, 'mgr');
  } else {
    filterCounselSection(allRows, null, null);
  }
}

function toggleTLFilter(key,name){
  const cached=mem[activeCk]; if(!cached)return;
  activeMgr=null;
  const wasActive = activeTL===key;
  activeTL = wasActive ? null : key;

  // Donut filter tag
  if(activeTL){ $('univFilterName').textContent=name; $('univFilterTag').classList.add('show'); }
  else { $('univFilterTag').classList.remove('show'); }

  syncBarStates();
  updateDonut(cached.data, lastTrendRows);

  // Filter counsellor section to show only this TL's counsellors
  const d = cached.data;
  const allRows = d.allTrendRows || d.trendRows || [];
  if(activeTL){
    const tlRows = allRows.filter(r=>resolveTL((r.tl||'').trim().toLowerCase())===key);
    filterCounselSection(tlRows, name, 'tl');
  } else {
    filterCounselSection(allRows, null, null);
  }
}

// â”€â”€ Filter counsellor section by manager or TL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterCounselSection(rows,label,type){
  const tag=$('counselFilterTag'),nameEl=$('counselFilterName');
  if(label&&type){nameEl.textContent=(type==='mgr'?'Mgr: ':'TL: ')+label;tag.classList.add('show');}
  else tag.classList.remove('show');
  const data=buildCounselMap(rows);
  if(!data.length){
    $('cPodium').innerHTML='';
    $('cGrid').innerHTML=nd(label?`No counsellors for ${label}`:'No counsellor data');
    $('incSection').style.display='none';
    $('cBadge').textContent=label?'0 COUNSELLORS':'0';
    return;
  }
  renderCounselSection(data,label);
}

// Render counsellor grid â€” array join (faster than string concat in hot loop)
function renderCGridData(data){
  const total=data.reduce((s,c)=>s+c.count,0)||1;
  const mx=data.length?data[0].count:1;
  const src=cSearchVal?data.filter(c=>c.name.toLowerCase().includes(cSearchVal)):data;
  const grid=$('cGrid');
  if(!src.length){grid.innerHTML=nd(`No match for "${cSearchVal}"`);return;}
  const parts=new Array(src.length);
  for(let i=0,L=src.length;i<L;i++){
    const c=src[i],col=DOT_CLR[i%DOT_CLR.length];
    const pct=Math.round((c.count/total)*100),ratio=c.count/mx;
    parts[i]=`<div class="cg-card${c.incentive>0?' has-inc':''}" style="border-color:${rgba(col,.15+ratio*.3)}" id="cgc${i}">`
      +`<div class="cg-fill" id="cgf${i}" style="background:${rgba(col,.12+ratio*.22)}"></div>`
      +`<div class="cg-dot" style="background:${col};box-shadow:0 0 5px ${rgba(col,.5)};flex-shrink:0"></div>`
      +`<div class="cg-body"><span class="cg-name" title="${c.name}">${c.name}</span>`
      +(c.incentive>0?`<span class="cg-inc" style="color:${col}">â‚¹${fmtInc(c.incentive)}</span>`:'')
      +`</div><div class="cg-right"><span class="cg-count">${c.count}</span><span class="cg-pct">${pct}%</span></div></div>`;
  }
  grid.innerHTML=parts.join('');
  // Single rAF â€” batch all fill transforms at once
  requestAnimationFrame(()=>{
    for(let i=0,L=src.length;i<L;i++){const e=$f('cgf'+i);if(e)e.style.transform=`scaleX(${src[i].count/mx})`;}
  });
}
function syncBarStates(){
  document.querySelectorAll('[data-mgr]').forEach(row=>{
    const k=row.dataset.mgr;
    row.classList.toggle('active-mgr', k===activeMgr);
    row.classList.toggle('dimmed', !!(activeMgr||activeTL) && k!==activeMgr);
  });
  document.querySelectorAll('[data-tl]').forEach(row=>{
    const k=row.dataset.tl;
    row.classList.toggle('active-mgr', k===activeTL);
    row.classList.toggle('dimmed', !!(activeMgr||activeTL) && k!==activeTL);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREND CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$q('.trend-filters').addEventListener('click',e=>{
  const b=e.target.closest('.tf'); if(!b)return;
  $q('.tf.on')?.classList.remove('on');
  b.classList.add('on');
  trendFilter=b.dataset.tf;
  // Use allTrendRows for trend chart so it shows full period data (not week-clipped)
  const c=mem[activeCk];
  if(c) drawTrend(c.data.allTrendRows||c.data.trendRows||[]);
},{passive:true});

function groupRows(rows, mode){
  // Map: sortKey â†’ { label, count, ts (numeric, for sorting) }
  const map = Object.create(null);

  for(let i=0, L=rows.length; i<L; i++){
    const r = rows[i];
    const dt = parseLocalDate(r.date);
    if(!dt || isNaN(dt.getTime())) continue;

    let key, ts;
    if(mode==='daily'){
      // Zero-padded YYYY-MM-DD â€” safe for string sort AND numeric ts
      key = dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
      ts  = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()).getTime();
    } else if(mode==='weekly'){
      const mon = monWeekStart(dt);
      key = mon.getFullYear()+'-'+String(mon.getMonth()+1).padStart(2,'0')+'-'+String(mon.getDate()).padStart(2,'0');
      ts  = mon.getTime();
    } else {
      // Monthly: YYYY-MM
      key = dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0');
      ts  = new Date(dt.getFullYear(), dt.getMonth(), 1).getTime();
    }

    if(!map[key]) map[key] = {key, ts, count:0};
    map[key].count++;
  }

  // Sort by numeric timestamp (never by string comparison)
  return Object.values(map)
    .sort((a,b) => a.ts - b.ts)
    .map(v => [v.key, v.count]);
}
function fmtKey(k, mode){
  // k is always YYYY-MM-DD (daily/weekly) or YYYY-MM (monthly)
  const p = k.split('-');
  const yr   = p[0];
  const mo   = +p[1]-1;  // 0-indexed month
  const day  = p[2]?+p[2]:1;
  const moStr = MO_SHORT[mo] || '?';

  if(mode==='monthly') return moStr+' '+yr;
  if(mode==='weekly')  return String(day)+' '+moStr;   // start of week date
  return String(day)+' '+moStr;                        // daily: DD Mon
}

function drawTrend(rows){
  const wrap=$('chartWrap'), svg=$('chartSvg'), tip=$('chartTip'), stats=$('trendStats');
  if(!rows.length){
    svg.innerHTML=`<text x="50%" y="50%" fill="rgba(255,255,255,.1)" text-anchor="middle" font-size="12" font-family="Plus Jakarta Sans">No trend data</text>`;
    stats.innerHTML=''; return;
  }
  const pts=groupRows(rows,trendFilter);
  if(!pts.length){ svg.innerHTML=''; stats.innerHTML=''; return; }

  const vals=pts.map(p=>p[1]);
  const total=vals.reduce((a,b)=>a+b,0);
  const avg=total/vals.length;
  const peak=Math.max(...vals);
  const peakKey=pts[vals.indexOf(peak)][0];
  // Trend: compare average of last 30% of points vs first 30% (more stable than first/last)
  let trendPct=0;
  if(vals.length>1){
    const chunk=Math.max(1,Math.floor(vals.length*0.3));
    const firstAvg=vals.slice(0,chunk).reduce((a,b)=>a+b,0)/chunk;
    const lastAvg =vals.slice(-chunk).reduce((a,b)=>a+b,0)/chunk;
    trendPct=firstAvg>0?Math.round(((lastAvg-firstAvg)/firstAvg)*100):0;
  }
  const unit=trendFilter==='monthly'?'MONTH':trendFilter==='weekly'?'WEEK':'DAY';

  stats.innerHTML=[
    `<div class="tstat neu"><div class="tstat-val">${total}</div><div class="tstat-lbl">TOTAL</div></div>`,
    `<div class="tstat neu"><div class="tstat-val">${avg.toFixed(1)}</div><div class="tstat-lbl">AVG/${unit}</div></div>`,
    `<div class="tstat neu"><div class="tstat-val">${peak}</div><div class="tstat-lbl">PEAK Â· ${fmtKey(peakKey,trendFilter)}</div></div>`,
    `<div class="tstat ${trendPct>=0?'up':'dn'}"><div class="tstat-val">${trendPct>=0?'+':''}${trendPct}%</div><div class="tstat-lbl">TREND</div></div>`,
  ].join('');

  const W=wrap.offsetWidth||900, H=200;
  const pL=38, pR=16, pT=20, pB=36;
  const cW=W-pL-pR, cH=H-pT-pB;
  const maxV=Math.max(...vals,1), n=pts.length;
  const xOf=i=>pL+(n===1?cW/2:i*(cW/(n-1)));
  const yOf=v=>pT+cH-(v/maxV)*cH;

  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  // Grid lines
  let grid='';
  [0,.25,.5,.75,1].forEach(t=>{
    const y=pT+cH-t*cH;
    grid+=`<line x1="${pL}" x2="${W-pR}" y1="${y}" y2="${y}" stroke="rgba(255,255,255,.05)" stroke-width="1"/>`;
    grid+=`<text x="${pL-6}" y="${y+4}" fill="rgba(255,255,255,.2)" font-size="9" text-anchor="end" font-family="Plus Jakarta Sans">${Math.round(t*maxV)}</text>`;
  });

  // Area + line path
  let area='', line='';
  if(n>1){
    area=`M ${xOf(0)} ${H-pB}`;
    pts.forEach((_,i)=>area+=` L ${xOf(i)} ${yOf(pts[i][1])}`);
    area+=` L ${xOf(n-1)} ${H-pB} Z`;
    line=`M ${xOf(0)} ${yOf(pts[0][1])}`;
    for(let i=1;i<n;i++){
      const x0=xOf(i-1),y0=yOf(pts[i-1][1]),x1=xOf(i),y1=yOf(pts[i][1]),cx=(x0+x1)/2;
      line+=` C ${cx} ${y0} ${cx} ${y1} ${x1} ${y1}`;
    }
  }

  // X labels
  const maxL=Math.min(n,8), step=Math.ceil(n/maxL);
  let xlbls='', dots='', hits='';
  pts.forEach((p,i)=>{
    const x=xOf(i), y=yOf(p[1]);
    if(i%step===0||i===n-1)
      xlbls+=`<text x="${x}" y="${H-pB+15}" fill="rgba(255,255,255,.22)" font-size="9" text-anchor="middle" font-family="Plus Jakarta Sans">${fmtKey(p[0],trendFilter)}</text>`;
    dots+=`<circle class="tdot" cx="${x}" cy="${y}" r="4" fill="#818cf8" stroke="#08091a" stroke-width="2" filter="url(#glow)" style="opacity:0;transition:opacity .2s ${i*15}ms"/>`;
    const hw=n>1?Math.max(16,cW/(n-1)/2):cW;
    hits+=`<rect x="${Math.max(pL,x-hw/2)}" y="${pT}" width="${hw}" height="${cH}" fill="transparent" data-i="${i}" class="thit" style="cursor:crosshair"/>`;
  });

  const pathLen = 2200;

  // â”€â”€ Replace SVG first (clears old listeners), then write content into new node â”€â”€
  const newSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  newSvg.id = 'chartSvg';
  newSvg.classList.add('chart-svg');
  newSvg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  wrap.replaceChild(newSvg, wrap.querySelector('#chartSvg') || wrap.querySelector('svg'));
  delete _elCache['chartSvg'];          // clear DOM cache so $() finds new node
  const liveSvg = newSvg;              // use newSvg directly â€” no stale reference

  liveSvg.innerHTML = `
    <defs>
      <linearGradient id="tg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#818cf8" stop-opacity="0.28"/>
        <stop offset="100%" stop-color="#818cf8" stop-opacity="0"/>
      </linearGradient>
      <linearGradient id="lg" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#6366f1"/>
        <stop offset="55%" stop-color="#818cf8"/>
        <stop offset="100%" stop-color="#22d3ee"/>
      </linearGradient>
      <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    ${grid}
    ${n>1 ? `<path d="${area}" fill="url(#tg)"/>
    <path id="tline" d="${line}" fill="none" stroke="url(#lg)" stroke-width="2.5" stroke-linecap="round"
      style="stroke-dasharray:${pathLen};stroke-dashoffset:${pathLen};transition:stroke-dashoffset 1.1s cubic-bezier(.16,1,.3,1)"/>` : ''}
    ${xlbls}${dots}${hits}`;

  // â”€â”€ Animate: draw line + fade in dots (on the LIVE node) â”€â”€
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    const tline = liveSvg.querySelector('#tline');
    if(tline) tline.style.strokeDashoffset = '0';
    liveSvg.querySelectorAll('.tdot').forEach(d => d.style.opacity = '1');
  }));

  // â”€â”€ Tooltip hover (attached to the correct live node) â”€â”€
  liveSvg.addEventListener('mouseover', e=>{
    const h = e.target.closest('.thit'); if(!h) return;
    const i = +h.dataset.i, pt = pts[i];
    const dot = liveSvg.querySelectorAll('.tdot')[i];
    if(dot) dot.setAttribute('r','6');
    tip.style.opacity = '1';
    $('ttDate').textContent = fmtKey(pt[0], trendFilter);
    $('ttVal').textContent  = pt[1] + ' admissions';
    const x = xOf(i), tipW = tip.offsetWidth||130;
    let tx = x - tipW/2;
    if(tx < 0) tx = 2;
    if(tx + tipW > W) tx = W - tipW - 2;
    tip.style.left = tx + 'px';
    tip.style.top  = (yOf(pt[1]) - 56 < 0 ? yOf(pt[1]) + 10 : yOf(pt[1]) - 56) + 'px';
  },{passive:true});

  liveSvg.addEventListener('mouseout', e=>{
    const h = e.target.closest('.thit'); if(!h) return;
    const dot = liveSvg.querySelectorAll('.tdot')[+h.dataset.i];
    if(dot) dot.setAttribute('r','4');
    tip.style.opacity = '0';
  },{passive:true});

  const t4=$('t4'); if(t4) t4.textContent='Updated '+new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNSELLOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('cSearch').addEventListener('input',function(){
  clearTimeout(searchTimer);
  searchTimer=setTimeout(()=>{
    cSearchVal=this.value.toLowerCase().trim();
    renderCGridData(allCounselData);
  },120);
},{passive:true});

// â”€â”€ Shared: build sorted counsellor data array from any trendRows â”€â”€
function buildCounselMap(rows){
  if(!rows||!rows.length) return [];
  const map=Object.create(null);
  for(let i=0,L=rows.length;i<L;i++){
    const r=rows[i];
    const raw=(r.counsellor||r.Counsellor||r.COUNSELLOR||r.counsel||r.Counsel||r.staff||r.Staff||r.employee||r.Employee||r.name||r.Name||'').toString().trim();
    if(!raw||raw.toLowerCase()==='none'||raw==='-') continue;
    // Fast title-case: no regex, no .map(), no .join()
    let key='',sp=true;
    for(let c=0;c<raw.length;c++){
      const ch=raw[c];
      if(ch===' '||ch==='\t'){key+=' ';sp=true;}
      else{key+=sp?ch.toUpperCase():ch.toLowerCase();sp=false;}
    }
    if(!map[key]) map[key]={count:0,incentive:0};
    map[key].count++;
    let inc=0;
    const rkeys=Object.keys(r);
    for(let j=0;j<rkeys.length;j++){
      const kl=rkeys[j].toLowerCase();
      if(kl.includes('incentive')||kl==='amount'||kl==='commission'){
        const v=parseFloat(r[rkeys[j]]); if(!isNaN(v)&&v>0){inc=v;break;}
      }
    }
    map[key].incentive+=inc;
  }
  return Object.entries(map)
    .map(([name,{count,incentive}])=>({name,count,incentive}))
    .sort((a,b)=>b.count-a.count);
}

// â”€â”€ Shared: paint podium + grid + incentive from any data array â”€â”€â”€â”€â”€â”€
const _pIco=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'],_pCls=['p1','p2','p3'],_pLbl=['TOP PERFORMER','2ND PLACE','3RD PLACE'];
function renderCounselSection(data,label){
  $('cBadge').textContent=(label?label+' Â· ':'')+data.length+' COUNSELLORS';
  const top=data.slice(0,3),parts=[];
  for(let i=0;i<top.length;i++){
    const c=top[i];
    parts.push(`<div class="c-pod ${_pCls[i]}"><span class="c-pod-ico">${_pIco[i]}</span><div class="c-pod-body"><span class="c-pod-name" title="${c.name}">${c.name}</span><span class="c-pod-lbl">${_pLbl[i]}</span></div><div class="c-pod-stats"><span class="c-pod-num">${c.count}</span>${c.incentive>0?`<span class="c-pod-inc">â‚¹${fmtInc(c.incentive)}</span>`:''}</div></div>`);
  }
  $('cPodium').innerHTML=parts.join('');
  renderCGridData(data);
  drawIncLeaderboard(data);
}

function drawCounsel(rows){
  const newData=buildCounselMap(rows);
  if(newData.length>0) allCounselData=newData;
  else if(!allCounselData.length){
    $('cPodium').innerHTML=''; $('cGrid').innerHTML=nd('No counsellor data'); $('cBadge').textContent='0'; return;
  }
  renderCounselSection(allCounselData,null);
  const t5=$('t5'); if(t5) t5.textContent='Updated '+new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

function drawIncLeaderboard(data){
  const withInc=data.filter(c=>c.incentive>0).sort((a,b)=>b.incentive-a.incentive);
  const sec=$('incSection');
  if(!withInc.length){ sec.style.display='none'; return; }
  sec.style.display='block';

  const maxInc=withInc[0].incentive;
  const totInc=withInc.reduce((a,b)=>a+b.incentive,0);
  $('incTotal').textContent='â‚¹'+fmtInc(totInc);

  const rCls=['r1','r2','r3'], rIco=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  let html='';
  for(let i=0,L=withInc.length;i<L;i++){
    const c=withInc[i];
    const rc=i<3?rCls[i]:'rn', ri=i<3?rIco[i]:(i+1), grad=INC_GRD[i%INC_GRD.length];
    html+=`<div class="inc-row">`;
    html+=`<div class="inc-rank ${rc}">${ri}</div>`;
    html+=`<div class="inc-name"><span class="inc-name-main" title="${c.name}">${c.name}</span><span class="inc-name-adm">${c.count} admissions</span></div>`;
    html+=`<div class="inc-track-wrap"><div class="inc-track"><div class="inc-bar" id="incb${i}" style="background:${grad};"></div></div><div class="inc-overlay"><span class="inc-ol-adm">${c.count} adm</span><span class="inc-ol-amt">â‚¹${fmtInc(c.incentive)}</span></div></div>`;
    html+=`<div class="inc-stats"><span class="inc-stat-amt">â‚¹${fmtInc(c.incentive)}</span><span class="inc-stat-adm">${c.count} adm</span></div>`;
    html+=`</div>`;
  }
  $('incChart').innerHTML=html;

  requestAnimationFrame(()=>{
    for(let i=0;i<withInc.length;i++){const e=$f('incb'+i);if(e){e.style.transition='none';e.style.transform='scaleX(0)';}}
    requestAnimationFrame(()=>{
      for(let i=0;i<withInc.length;i++){const e=$f('incb'+i);if(e){e.style.transition='';e.style.transform=`scaleX(${withInc[i].incentive/maxInc})`;}}
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$q('.tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab');
  if(!t||t.classList.contains('on')) return;
  $q('.tab.on')?.classList.remove('on');
  t.classList.add('on');
  clearRange();
  const p=t.getAttribute('data-p');
  if(p==='lastweek'){
    const n=new Date(); n.setHours(0,0,0,0);
    const thisMon=monWeekStart(n);
    const lMon=new Date(thisMon); lMon.setDate(lMon.getDate()-7);
    const lSun=new Date(lMon);    lSun.setDate(lSun.getDate()+6);
    load('lastweek', iso(lMon), iso(lSun));
  } else if(p==='thisweek'){
    // Pass today's Monâ€“Sun explicitly so Apps Script also filters correctly
    const n=new Date(); n.setHours(0,0,0,0);
    const wMon=monWeekStart(n);
    const wSun=sunWeekEnd(n);
    load('weekly', iso(wMon), iso(wSun));
  } else {
    load(p);
  }
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calY=new Date().getFullYear(), calM=new Date().getMonth();
let rStart=null, rEnd=null, hoverDt=null;

// Init DOW header once
(()=>{ DOWS.forEach(l=>{ const e=document.createElement('div'); e.className='cal-dow'; e.textContent=l; $('calDow').appendChild(e); }); })();

// Persistent listeners on container (never re-added)
$('calDays').addEventListener('click',e=>{
  const el=e.target.closest('.cal-day');
  if(!el||el.classList.contains('empty')) return;
  const dt=new Date(+el.dataset.ts);
  if(!rStart||rEnd){ rStart=dt; rEnd=null; hoverDt=null; }
  else{
    const ts=dayTs(dt), rs=dayTs(rStart);
    if(ts<rs){ rEnd=new Date(rStart); rStart=dt; }
    else if(ts===rs){ rEnd=new Date(rStart); }
    else { rEnd=dt; }
    hoverDt=null;
  }
  paintCal();
},{passive:true});

$('calDays').addEventListener('mouseover',e=>{
  const el=e.target.closest('.cal-day');
  if(!el||el.classList.contains('empty')) return;
  if(rStart&&!rEnd){ hoverDt=new Date(+el.dataset.ts); paintCal(); }
},{passive:true});

$('calDays').addEventListener('mouseleave',()=>{
  if(rStart&&!rEnd){ hoverDt=null; paintCal(); }
},{passive:true});

function buildCal(){
  $('calMonthLbl').textContent=MONTHS[calM]+' '+calY;
  const frag=document.createDocumentFragment();
  const first=new Date(calY,calM,1).getDay();
  const days =new Date(calY,calM+1,0).getDate();
  for(let i=0;i<first;i++){
    const e=document.createElement('div'); e.className='cal-day empty'; frag.appendChild(e);
  }
  for(let d=1;d<=days;d++){
    const ts=dayTs(new Date(calY,calM,d));
    const el=document.createElement('div');
    el.className='cal-day'; el.textContent=d; el.dataset.ts=ts;
    if(ts===TODAY_TS) el.classList.add('today');
    frag.appendChild(el);
  }
  $('calDays').innerHTML='';
  $('calDays').appendChild(frag);
  paintCal();
}

function paintCal(){
  const effEnd=rEnd||(rStart&&hoverDt?hoverDt:null);
  let lo=0, hi=0;
  if(rStart&&effEnd){
    const a=dayTs(rStart), b=dayTs(effEnd);
    lo=Math.min(a,b); hi=Math.max(a,b);
  } else if(rStart){ lo=hi=dayTs(rStart); }

  $('calDays').querySelectorAll('.cal-day:not(.empty)').forEach(el=>{
    const ts=+el.dataset.ts;
    el.classList.remove('range-start','range-end','in-range');
    if(lo===hi&&ts===lo)           { el.classList.add('range-start','range-end'); }
    else if(ts===lo)               { el.classList.add('range-start'); }
    else if(ts===hi)               { el.classList.add('range-end'); }
    else if(ts>lo&&ts<hi)          { el.classList.add('in-range'); }
  });

  $('rdFrom').textContent=rStart?fmtDisp(rStart):'â€”';
  $('rdTo').textContent  =rEnd?fmtDisp(rEnd):(hoverDt&&rStart?fmtDisp(hoverDt):(rStart?'Pick endâ€¦':'â€”'));
  $('btnApply').disabled =!(rStart&&rEnd);
}

$('prevMo').addEventListener('click',()=>{ calM--; if(calM<0){calM=11;calY--;} buildCal(); },{passive:true});
$('nextMo').addEventListener('click',()=>{ calM++; if(calM>11){calM=0;calY++;} buildCal(); },{passive:true});

$q('.presets').addEventListener('click',e=>{
  const p=e.target.closest('.preset'); if(!p)return;
  $q('.preset.sel')?.classList.remove('sel'); p.classList.add('sel');
  const n=new Date(); n.setHours(0,0,0,0);
  const key=p.dataset.preset; let s=null, en=null;
  if     (key==='today')     { s=new Date(n); en=new Date(n); }
  else if(key==='yesterday') { s=new Date(n); s.setDate(s.getDate()-1); en=new Date(s); }
  else if(key==='last7')     { s=new Date(n); s.setDate(s.getDate()-6); en=new Date(n); }
  else if(key==='last30')    { s=new Date(n); s.setDate(s.getDate()-29); en=new Date(n); }
  else if(key==='thismonth') { s=new Date(n.getFullYear(),n.getMonth(),1); en=new Date(n); }
  else if(key==='lastmonth') { s=new Date(n.getFullYear(),n.getMonth()-1,1); en=new Date(n.getFullYear(),n.getMonth(),0); }
  else if(key==='thisyear')  { s=new Date(n.getFullYear(),0,1); en=new Date(n); }
  else if(key==='alltime')   { closeCal(); clearRange(); $q('[data-p="all"]').click(); return; }
  if(!s||!en) return;
  rStart=s; rEnd=en; hoverDt=null;
  calY=s.getFullYear(); calM=s.getMonth();
  buildCal();
},{passive:true});

$('btnApply').addEventListener('click',()=>{
  if(!rStart||!rEnd) return;
  const f=iso(rStart), t=iso(rEnd);
  if(customFrom&&customTo) delete mem[`cr_${customFrom}_${customTo}`];
  customFrom=f; customTo=t;
  $q('.tab.on')?.classList.remove('on');
  $('calBtn').classList.add('active');
  $('rangeBadge').classList.add('show');
  $('rangeBadgeTxt').textContent=fmtDisp(rStart)+' â†’ '+fmtDisp(rEnd);
  closeCal();
  load('custom',f,t,true);
});

$('btnClear').addEventListener('click',()=>{
  rStart=null; rEnd=null; hoverDt=null;
  $q('.preset.sel')?.classList.remove('sel');
  paintCal();
},{passive:true});

function openCal(){
  const ref=rStart||new Date();
  calY=ref.getFullYear(); calM=ref.getMonth();
  buildCal();
  $('calPanel').classList.add('open');
  $('calOverlay').classList.add('open');
  $('calBtn').classList.add('active');
}
function closeCal(){
  $('calPanel').classList.remove('open');
  $('calOverlay').classList.remove('open');
}
function clearRange(){
  customFrom=null; customTo=null; rStart=null; rEnd=null; hoverDt=null;
  $('rangeBadge').classList.remove('show');
  $('calBtn').classList.remove('active');
  $q('.preset.sel')?.classList.remove('sel');
}

$('calBtn').addEventListener('click',openCal,{passive:true});
$('calClose').addEventListener('click',closeCal,{passive:true});
$('calOverlay').addEventListener('click',closeCal,{passive:true});

$('rangeBadgeX').addEventListener('click',()=>{
  clearRange();
  $q('[data-p="all"]').click();
},{passive:true});

$('univFilterX').addEventListener('click',()=>{
  const c=mem[activeCk]; if(!c)return;
  activeMgr=null; activeTL=null;
  syncBarStates();
  $('univFilterTag').classList.remove('show');
  updateDonut(c.data,lastTrendRows);
  // Also reset counsellor filter
  const allRows=(c.data.allTrendRows||c.data.trendRows||[]);
  filterCounselSection(allRows, null, null);
},{passive:true});

// Counsellor filter X â€” clear manager/TL filter
$('counselFilterX').addEventListener('click',()=>{
  const c=mem[activeCk]; if(!c)return;
  activeMgr=null; activeTL=null;
  syncBarStates();
  $('univFilterTag').classList.remove('show');
  updateDonut(c.data,lastTrendRows);
  const allRows=(c.data.allTrendRows||c.data.trendRows||[]);
  filterCounselSection(allRows, null, null);
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function boot(){
  // Instant render from disk if available
  const dk=dkRead('all');
  if(dk){
    mem['all']={data:dk.data,ts:dk.ts};
    activeCk='all'; activePeriod='all';
    render(dk.data,true,'all');
    showDash();
  }
  // Fresh fetch
  load('all');
  // Prefetch all other tabs in parallel
  setTimeout(prefetchAll, dk?800:200);
})();
</script>
</body>
</html>
